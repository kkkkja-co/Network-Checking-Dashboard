<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
            color: #334155;
        }
        .card {
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.75rem;
            z-index: 1;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }

        /* --- GAUGE STYLES --- */
        svg.gauge-svg { overflow: visible; }
        .gauge-bg { stroke: #cbd5e1; fill: #f1f5f9; opacity: 0.5; }
        .gauge-fill {
            stroke: #10b981;
            stroke-linecap: round;
            transition: stroke-dasharray 0.6s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.3s ease;
        }
        .no-anim-trans { transition: none !important; }
        .gauge-pulse { animation: gaugeGlow 1.5s ease-in-out infinite alternate; }
        @keyframes gaugeGlow {
            from { filter: drop-shadow(0 0 2px rgba(16, 185, 129, 0.4)); stroke-width: 2.5; }
            to { filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.8)); stroke-width: 2.8; }
        }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 relative">

<div id="cookie-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[5000] hidden opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md mx-4 transform scale-95 transition-transform duration-300" id="cookie-content">
        <div class="text-center mb-4">
            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                <i class="fas fa-cookie-bite text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Terms of Service & History</h3>
            <p class="text-sm text-gray-500 mt-2">
                To use this dashboard, you must acknowledge and agree to the
                <button onclick="openPrivacy()" class="text-blue-600 hover:underline font-bold">Privacy Policy</button>
                and the <strong>End User License Agreements (EULA)</strong> of our third-party data providers. We also utilize cookies to store your speed test history locally.
                <br><br>
                <strong>Please select your preference to accept these terms:</strong>
            </p>
        </div>
        <div class="flex flex-col space-y-3 mt-6">
            <button onclick="handleConsent(true)" class="w-full py-3 px-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition shadow-lg shadow-emerald-200 text-sm">
                Agree to Terms & Enable History
            </button>
            <button onclick="handleConsent(false)" class="w-full py-3 px-4 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg font-medium transition text-xs border border-gray-200">
                Agree to Terms & Use Necessary Cookies Only
            </button>
        </div>
    </div>
</div>

<div id="privacy-modal" class="fixed inset-0 z-[6000] hidden transition-opacity duration-300 opacity-0 bg-white/95 backdrop-blur-sm">
    <div id="privacy-content" class="w-full h-full overflow-y-auto transform transition-transform duration-300 scale-95">
        <div class="max-w-4xl mx-auto p-8 md:p-12 bg-white min-h-screen shadow-2xl border-x border-gray-100">
            <div class="flex justify-between items-center mb-8 border-b pb-4 sticky top-0 bg-white/95 backdrop-blur z-10 pt-2">
                <h1 class="text-3xl font-bold text-slate-900">Privacy Policy</h1>
                <button onclick="closePrivacy()" class="text-slate-500 hover:text-slate-800 transition text-xl px-4 py-2 hover:bg-slate-100 rounded-lg">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            <div class="prose prose-slate max-w-none text-slate-700 pb-12">
                <p class="text-lg mb-4">Last Updated: <span id="policy-date"></span></p>

                <h3 class="text-xl font-bold mt-6 mb-2 text-slate-900">1. Privacy-First & Zero Data Collection</h3>
                <p class="mb-4">This Network Dashboard is built with a strict <strong>Privacy-First</strong> philosophy. We operate as a purely <strong>client-side application</strong>. This means:</p>
                <ul class="list-disc pl-5 mb-4 space-y-1">
                    <li><strong>No Backend Database:</strong> We do not have a server that stores your personal data or speed test history.</li>
                    <li><strong>No Tracking:</strong> We do not track your IP address, browser behavior, or location on our servers.</li>
                    <li><strong>No Selling of Data:</strong> Since we do not collect your data, we cannot (and will not) sell or share it with advertisers or third parties.</li>
                </ul>
                <p class="mb-4">All processing happens locally within your web browser. Your data remains strictly on your own device.</p>

                <h3 class="text-xl font-bold mt-6 mb-2 text-slate-900">2. Third-Party Data Processing</h3>
                <p class="mb-4">While <strong>we</strong> do not collect your data, this tool requires connections to external Third-Party APIs to function (e.g., to measure speed or detect your ISP). By using this tool, you acknowledge that your IP address and network requests must be processed by the following providers solely to return the requested information:</p>
                <ul class="list-disc pl-5 mb-4 space-y-2">
                    <li><strong>Cloudflare</strong> (Speed Test Engine & Trace Data)</li>
                    <li><strong>ipwho.is</strong> (IP Geolocation, ISP, & ASN Data)</li>
                    <li><strong>ipify</strong> (IPv6 Detection)</li>
                    <li><strong>ip-api</strong> (DNS Leak Detection)</li>
                    <li><strong>OpenStreetMap</strong> (Map Visualizations)</li>
                </ul>

                <h3 class="text-xl font-bold mt-6 mb-2 text-slate-900">3. Cookies & Local Storage</h3>
                <p class="mb-4">We use browser cookies only to enhance your local experience:</p>
                <ul class="list-disc pl-5 mb-4 space-y-1">
                    <li><strong>Consent Cookie:</strong> Remembers if you accepted the terms so we don't ask every time.</li>
                    <li><strong>History Cookie:</strong> If enabled, saves your past results <strong>locally on your device</strong> for your reference only. This data is never uploaded.</li>
                </ul>
                <p class="mb-4">You maintain full control. You can wipe this data instantly by clearing your browser cache or clicking the "Clear" button in the dashboard history.</p>

                <h3 class="text-xl font-bold mt-6 mb-2 text-slate-900">4. Disclaimer</h3>
                <p class="mb-4">This tool is provided "as is" without warranty. Speed test results are estimates. We prioritize your privacy above all else.</p>
            </div>
        </div>
    </div>
</div>

<div id="tz-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[7000] hidden opacity-0 transition-opacity duration-300" onclick="closeTz()">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300 relative max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
        <button onclick="closeTz()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-lg"></i></button>
        <div class="mb-5 flex-shrink-0">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="far fa-clock text-blue-500"></i> Timezone Check</h3>
            <p class="text-xs text-gray-500 mt-1">Detailed system time configuration</p>
        </div>
        <div class="space-y-4 overflow-y-auto custom-scroll pr-1">
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                <p class="text-[10px] text-blue-500 uppercase font-bold tracking-wider mb-1">UTC Offset</p>
                <p id="modal-utc" class="font-mono text-2xl font-bold text-blue-700 tracking-tight">--</p>
            </div>
            <div class="grid grid-cols-1 gap-3">
                <div class="border-b border-gray-100 pb-2">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-0.5">IANA Region Code</p>
                    <p id="modal-region" class="font-mono text-sm font-semibold text-slate-700">--</p>
                </div>
                <div class="border-b border-gray-100 pb-2">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-0.5">Local System Time</p>
                    <p id="modal-local" class="font-mono text-xs text-slate-600 break-words leading-tight">--</p>
                </div>
                <div class="border-b border-gray-100 pb-2">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-0.5">UTC Time</p>
                    <p id="modal-global" class="font-mono text-xs text-slate-600 break-words leading-tight">--</p>
                </div>
                <div>
                    <p id="modal-regions-title" class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">Regions with same UTC Offset</p>
                    <div class="bg-gray-50 rounded border border-gray-200 p-2 h-32 overflow-y-auto custom-scroll">
                        <ul id="modal-all-regions" class="text-[10px] font-mono text-slate-600 space-y-1"><li>Loading...</li></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="os-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[7000] hidden opacity-0 transition-opacity duration-300" onclick="closeOsModal()">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4 transform scale-95 transition-transform duration-300 relative max-h-[90vh] overflow-y-auto custom-scroll" onclick="event.stopPropagation()">
        <button onclick="closeOsModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-lg"></i></button>
        <div class="mb-5">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-microchip text-teal-500"></i> System & Hardware</h3>
            <p class="text-xs text-gray-500 mt-1">Detailed Operating System & Device Info</p>
        </div>
        <div class="space-y-4">
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">CPU & Architecture</h4>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div><span class="text-gray-400 block">Cores (Logical)</span><span class="font-mono font-bold text-slate-700" id="os-cores">--</span></div>
                    <div><span class="text-gray-400 block">Architecture</span><span class="font-mono font-bold text-slate-700" id="os-arch">--</span></div>
                    <div><span class="text-gray-400 block">Bitness</span><span class="font-mono font-bold text-slate-700" id="os-bitness">--</span></div>
                    <div><span class="text-gray-400 block">Memory (RAM)</span><span class="font-mono font-bold text-slate-700" id="os-memory">--</span></div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Device Identity</h4>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div><span class="text-gray-400 block">Vendor</span><span class="font-mono font-bold text-slate-700" id="os-vendor">--</span></div>
                    <div><span class="text-gray-400 block">Model</span><span class="font-mono font-bold text-slate-700" id="os-model">--</span></div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Display & Graphics</h4>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div><span class="text-gray-400 block">Resolution</span><span class="font-mono font-bold text-slate-700" id="os-res">--</span></div>
                    <div><span class="text-gray-400 block">Color Depth</span><span class="font-mono font-bold text-slate-700" id="os-cdepth">--</span></div>
                    <div><span class="text-gray-400 block">Pixel Depth</span><span class="font-mono font-bold text-slate-700" id="os-pdepth">--</span></div>
                    <div><span class="text-gray-400 block">Orientation</span><span class="font-mono font-bold text-slate-700" id="os-orient">--</span></div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Capabilities</h4>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between border-b border-slate-100 pb-1">
                        <span class="text-gray-500">PDF Viewer</span>
                        <span class="font-bold text-slate-700" id="os-pdf">--</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-1 pt-1">
                        <span class="text-gray-500">Media Codecs</span>
                        <span class="font-bold text-slate-700" id="os-media">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="browser-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[7000] hidden opacity-0 transition-opacity duration-300" onclick="closeBrowserModal()">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4 transform scale-95 transition-transform duration-300 relative" onclick="event.stopPropagation()">
        <button onclick="closeBrowserModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-lg"></i></button>
        <div class="mb-5">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fab fa-chrome text-orange-500"></i> Browser Information</h3>
            <p class="text-xs text-gray-500 mt-1">Detailed Browser Identity</p>
        </div>
        <div class="space-y-4">
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 font-mono text-xs text-slate-600 break-all leading-relaxed" id="modal-ua-raw">Loading...</div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Browser Identity</h4>
                <div class="grid grid-cols-2 gap-y-2 text-xs">
                    <div><span class="text-gray-400 block">Name</span><span class="font-bold text-slate-700" id="br-name">--</span></div>
                    <div><span class="text-gray-400 block">Version</span><span class="font-bold text-slate-700" id="br-ver">--</span></div>
                    <div><span class="text-gray-400 block">Engine</span><span class="font-bold text-slate-700" id="br-eng">--</span></div>
                    <div><span class="text-gray-400 block">Eng. Ver</span><span class="font-bold text-slate-700" id="br-eng-ver">--</span></div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Settings & Permissions</h4>
                <div class="grid grid-cols-2 gap-y-2 text-xs">
                    <div><span class="text-gray-400 block">Cookies</span><span class="font-bold text-slate-700" id="br-cookies">--</span></div>
                    <div><span class="text-gray-400 block">JavaScript</span><span class="font-bold text-slate-700" id="br-js">--</span></div>
                </div>
            </div>
        </div>
        <div class="mt-4 flex justify-end">
            <button onclick="copyUA()" class="text-xs bg-slate-800 text-white hover:bg-slate-700 px-4 py-2 rounded transition shadow flex items-center"><i class="far fa-copy mr-2"></i> Copy User Agent</button>
        </div>
    </div>
</div>

<div id="vpn-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[7000] hidden opacity-0 transition-opacity duration-300" onclick="closeVpnModal()">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300 relative max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <button onclick="closeVpnModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-lg"></i></button>
        <div class="mb-5">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-shield-alt text-cyan-500"></i> VPN & Privacy Report</h3>
            <p class="text-xs text-gray-500 mt-1">Detailed Analysis of your connection privacy</p>
        </div>
        <div class="space-y-4">
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 flex justify-between items-center">
                <span class="text-sm font-bold text-slate-600">Privacy Level</span>
                <span id="vpn-risk-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-gray-200 text-gray-600">Calculating...</span>
            </div>

            <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 h-auto min-h-[80px]">
                <h4 class="text-xs font-bold text-purple-500 uppercase mb-2">Provider & Risk Analysis</h4>

                <div class="grid grid-cols-2 gap-4 text-xs items-start">
                    <div class="flex flex-col">
                        <span class="text-gray-400 mb-0.5">Detected Provider</span>
                        <span class="font-bold text-slate-700 break-words whitespace-normal leading-snug" id="vpn-provider-name">--</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-gray-400 mb-0.5">IP Fraud Risk</span>
                        <span class="font-bold text-slate-700 break-words" id="vpn-fraud-score">--</span>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                <h4 class="text-xs font-bold text-blue-500 uppercase mb-2">Tracking Protection</h4>
                <div class="grid grid-cols-2 gap-y-2 text-xs">
                    <div>
                        <span class="text-gray-400 block">Do Not Track</span>
                        <span class="font-bold text-slate-700" id="priv-dnt">--</span>
                    </div>
                </div>
            </div>

            <div class="border-b border-gray-100 pb-3">
                <div class="flex justify-between items-center mb-1"><p class="text-xs font-bold text-slate-700">1. ISP / ASN Check</p><i id="icon-isp" class="fas fa-circle text-[10px] text-gray-300"></i></div>
                <p class="text-[10px] text-gray-500" id="desc-isp">Analyzing provider name...</p>
            </div>
            <div class="border-b border-gray-100 pb-3">
                <div class="flex justify-between items-center mb-1"><p class="text-xs font-bold text-slate-700">2. Timezone Consistency</p><i id="icon-tz" class="fas fa-circle text-[10px] text-gray-300"></i></div>
                <p class="text-[10px] text-gray-500" id="desc-tz">Comparing System vs IP Time...</p>
            </div>
            <div class="border-b border-gray-100 pb-3">
                <div class="flex justify-between items-center mb-1"><p class="text-xs font-bold text-slate-700">3. Language / Locale</p><i id="icon-lang" class="fas fa-circle text-[10px] text-gray-300"></i></div>
                <p class="text-[10px] text-gray-500" id="desc-lang">Checking browser language vs IP country...</p>
            </div>
            <div class="border-b border-gray-100 pb-3">
                <div class="flex justify-between items-center mb-1"><p class="text-xs font-bold text-slate-700">4. WebRTC Leak</p><i id="icon-webrtc" class="fas fa-circle text-[10px] text-gray-300"></i></div>
                <p class="text-[10px] text-gray-500" id="desc-webrtc">Checking for leaked IPs...</p>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1"><p class="text-xs font-bold text-slate-700">5. Tor / Onion Routing</p><i id="icon-tor" class="fas fa-circle text-[10px] text-gray-300"></i></div>
                <p class="text-[10px] text-gray-500" id="desc-tor">Checking for Tor exit nodes...</p>
            </div>
        </div>
    </div>
</div>

<div id="speed-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[7000] hidden opacity-0 transition-opacity duration-300" onclick="closeSpeedModal()">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300 relative max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <button onclick="closeSpeedModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-lg"></i></button>
        <div class="mb-5">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i class="fas fa-tachometer-alt text-emerald-500"></i> Speed Analysis
            </h3>
            <p class="text-xs text-gray-500 mt-1">Detailed Network Performance Metrics</p>
        </div>

        <div class="space-y-4">
            <div class="flex items-center justify-between bg-slate-50 p-4 rounded-lg border border-slate-200">
                <div>
                    <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider">Network Grade</p>
                    <p class="text-xs text-gray-400 mt-1">Based on Speed/Latency</p>
                </div>
                <div id="net-grade" class="text-3xl font-black text-slate-300">--</div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                    <p class="text-[10px] font-bold text-blue-500 uppercase mb-1">Download</p>
                    <p id="modal-dl" class="text-lg font-bold text-slate-800">--</p>
                </div>
                <div class="p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                    <p class="text-[10px] font-bold text-purple-500 uppercase mb-1">Upload</p>
                    <p id="modal-ul" class="text-lg font-bold text-slate-800">--</p>
                </div>
                <div class="p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                    <p class="text-[10px] font-bold text-orange-500 uppercase mb-1">Latency (Ping)</p>
                    <p id="modal-ping" class="text-lg font-bold text-slate-800">--</p>
                </div>
                <div class="p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                    <p class="text-[10px] font-bold text-teal-500 uppercase mb-1">Jitter</p>
                    <p id="modal-jitter" class="text-lg font-bold text-slate-800">--</p>
                </div>
            </div>

            <div class="bg-red-50 p-3 rounded-lg border border-red-100 flex justify-between items-center">
                <div>
                    <p class="text-xs font-bold text-red-500 uppercase">Packet Loss</p>
                    <p class="text-[10px] text-red-400">Estimated TCP Success Rate</p>
                </div>
                <p id="modal-ploss" class="text-lg font-bold text-red-600">--</p>
            </div>

            <div class="border-t border-gray-100 pt-3">
                <p class="text-xs font-bold text-slate-500 mb-2 uppercase">Streaming Capability</p>
                <div class="flex gap-2">
                    <span id="badge-4k" class="opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold">4K HDR</span>
                    <span id="badge-1080p" class="opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold">1080p HD</span>
                    <span id="badge-720p" class="opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold">720p</span>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="max-w-7xl mx-auto">

    <header class="mb-4 flex flex-col md:flex-row justify-between items-end md:items-center border-b border-gray-200 pb-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Network Dashboard</h1>
            <div class="flex items-center mt-1 space-x-3 text-xs text-gray-500 font-mono">
                <span id="last-update">--</span>
            </div>
        </div>
        <div class="flex gap-2 mt-3 md:mt-0 items-center">
            <a href="https://github.com/kkkkja-co/Network-Checking-Dashboard" target="_blank" class="px-3 py-1.5 bg-slate-800 text-white rounded text-sm shadow hover:bg-slate-900 transition flex items-center font-semibold">
                <i class="fab fa-github text-sm md:mr-2"></i> <span class="hidden md:inline">GitHub</span>
            </a>

            <button onclick="window.location.reload()" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-700 rounded text-sm shadow-sm hover:bg-gray-50 transition flex items-center">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </header>

    <div class="flex justify-center mb-6">
        <span class="text-xs font-medium text-slate-400 bg-slate-100 px-3 py-1 rounded-full flex items-center shadow-sm">
            <i class="fas fa-arrow-down mr-2 animate-bounce text-slate-500"></i> Scroll down for more
        </span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-blue-500 relative">
            <div class="flex justify-between items-start">
                <div class="w-full">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Public IPv4</p>
                    <h2 class="text-xl font-bold text-slate-800 mt-1 font-mono" id="ipv4-display"><span class="loader"></span></h2>
                    <p class="text-xs text-gray-500 mt-1" id="ipv4-loc">Locating...</p>
                    <p class="text-xs text-gray-400 font-mono mt-0.5 mb-2 cursor-pointer hover:text-blue-600 transition decoration-dotted underline underline-offset-4"
                       id="sys-tz" onclick="showTzModal()" title="Click for extra info">
                        Sys Timezone: <span class="loader w-3 h-3 border-2"></span>
                    </p>
                </div>
                <div class="p-2 bg-blue-50 rounded-lg text-blue-600 ml-2 absolute top-5 right-5"><i class="fas fa-globe"></i></div>
            </div>
            <div class="pt-3 border-t border-gray-100 mt-2">
                <div class="flex flex-row">
                    <div class="flex-1 pr-3 border-r border-gray-200">
                        <div class="mb-3">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">ISP</p>
                            <p class="text-xs font-bold text-slate-700 leading-tight break-words" id="isp-display">--</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Organization</p>
                            <p class="text-xs font-medium text-slate-600 leading-tight break-words" id="org-display">--</p>
                        </div>
                    </div>
                    <div class="flex-1 pl-3">
                        <div class="mb-3">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">AS Organization</p>
                            <p class="text-xs font-bold text-slate-700 leading-tight break-words" id="as-org-display">--</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">AS Number</p>
                            <p class="text-xs font-mono font-medium text-slate-600 leading-tight" id="asn-display">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-purple-500 relative">
            <div class="flex justify-between items-start">
                <div class="w-full overflow-hidden">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Public IPv6</p>
                    <h2 class="text-xl font-bold text-slate-800 mt-1 font-mono break-all leading-tight" id="ipv6-display"><span class="loader"></span></h2>
                    <p class="text-xs text-gray-500 mt-1 mb-2" id="ipv6-status">Checking...</p>
                </div>
                <div class="p-2 bg-purple-50 rounded-lg text-purple-600 ml-2 absolute top-5 right-5"><i class="fas fa-project-diagram"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Provider (v6)</p>
                <p class="text-sm font-bold text-slate-700 leading-tight" id="ipv6-provider">--</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-red-500 relative">
            <div class="flex justify-between items-start mb-2">
                <div class="w-full">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">WebRTC / LAN IP</p>
                    <ul id="webrtc-list" class="mt-2 space-y-1">
                        <li class="flex items-center text-sm"><span class="loader mr-2"></span> Scanning...</li>
                    </ul>
                </div>
                <div class="p-2 bg-red-50 rounded-lg text-red-600 ml-2 absolute top-5 right-5"><i class="fas fa-network-wired"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs text-gray-400">Local Network Leaks</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-pink-500 relative h-full flex flex-col justify-between">
            <div class="flex justify-between items-start mb-2 shrink-0">
                <div class="w-full">
                    <div class="flex items-center justify-between pr-10">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">DNS Servers</p>
                        <span id="dns-count-badge" class="hidden text-[10px] bg-pink-100 text-pink-700 px-2 py-0.5 rounded-full font-bold uppercase tracking-wide">0 Found</span>
                    </div>
                </div>
                <div class="p-2 bg-pink-50 rounded-lg text-pink-600 ml-2 absolute top-5 right-5"><i class="fas fa-server"></i></div>
            </div>
            <div class="h-40 overflow-y-auto custom-scroll relative mt-2 w-full">
                <ul id="dns-list" class="space-y-2 h-full break-all">
                    <li class="text-sm text-gray-600 flex items-center h-full"><span class="loader mr-2"></span> Probing...</li>
                </ul>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto shrink-0">
                <p class="text-xs text-gray-400">Detected Resolvers</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-indigo-500 relative min-h-[11rem]">
            <div class="flex justify-between items-start">
                <div class="w-full">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Hostname</p>
                    <h2 class="text-lg font-bold text-slate-800 mt-1 font-mono break-all leading-snug" id="hostname-display"><span class="loader"></span></h2>
                </div>
                <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600 ml-2 absolute top-5 right-5"><i class="fas fa-tag"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs text-gray-400">Reverse DNS / PTR</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-teal-500 relative min-h-[11rem]">
            <div class="flex justify-between items-start">
                <div class="w-full">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Operating System</p>
                    <h2 class="text-lg font-bold text-slate-800 mt-1" id="os-name">--</h2>
                    <p class="text-xs text-gray-500" id="os-detail">--</p>
                    <button onclick="showOsModal()" class="text-xs text-gray-400 font-mono hover:text-blue-600 transition flex items-center mt-1">
                        <span class="decoration-dotted underline underline-offset-4">More Info</span> <i class="fas fa-info-circle ml-1"></i>
                    </button>
                </div>
                <div class="p-2 bg-teal-50 rounded-lg text-teal-600 ml-2 absolute top-5 right-5"><i class="fas fa-microchip"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs text-gray-400">Platform Details</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-orange-500 relative">
            <div class="flex justify-between items-start">
                <div class="w-full">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Browser</p>
                    <h2 class="text-lg font-bold text-slate-800 mt-1" id="browser-name">--</h2>
                    <p class="text-xs text-gray-500 mb-1" id="browser-ver">--</p>
                    <button onclick="showBrowserModal()" class="text-xs text-gray-400 font-mono hover:text-blue-600 transition flex items-center">
                        <span class="decoration-dotted underline underline-offset-4">More Info</span> <i class="fas fa-info-circle ml-1"></i>
                    </button>
                </div>
                <div class="p-2 bg-orange-50 rounded-lg text-orange-600 ml-2 absolute top-5 right-5"><i class="fab fa-chrome"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs text-gray-400">Browser Details</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-cyan-500 relative">
            <div class="flex justify-between items-start">
                <div class="w-full">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">VPN / Privacy Check</p>
                            <h2 class="text-lg font-bold mt-1" id="vpn-status"><span class="loader"></span></h2>
                        </div>
                    </div>
                    <button onclick="showVpnModal()" class="text-xs text-gray-400 font-mono hover:text-blue-600 transition flex items-center mt-1 mb-2">
                        <span class="decoration-dotted underline underline-offset-4">More Info</span> <i class="fas fa-info-circle ml-1"></i>
                    </button>
                    <div id="vpn-details" class="text-xs text-gray-500 leading-tight">Analyzing...</div>
                </div>
                <div class="p-2 bg-cyan-50 rounded-lg text-cyan-600 ml-2 absolute top-5 right-5"><i class="fas fa-user-secret"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs text-gray-400">Proxy & ISP Analysis</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-1 border border-gray-100 md:col-span-2 md:row-span-2 h-96 relative z-0">
            <div id="map"></div>
            <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-2 rounded shadow text-xs z-[999] border border-gray-200">
                <strong>Coordinates</strong><br>
                <span id="map-coords" class="text-gray-500 font-mono">--</span>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-6 border-t-4 border-emerald-500 md:col-span-2 md:row-span-2">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Speed Test (Multi-Stream)</h3>
                    <p class="text-xs text-gray-400 mt-1 mb-1">4 Concurrent Connections</p>
                    <button onclick="showSpeedModal()" class="text-xs text-gray-400 font-mono hover:text-blue-600 transition flex items-center">
                        <span class="decoration-dotted underline underline-offset-4">More Info</span> <i class="fas fa-info-circle ml-1"></i>
                    </button>
                </div>
                <div id="speed-status-icon" class="p-2 bg-gray-50 rounded-lg text-gray-400"><i class="fas fa-wifi"></i></div>
            </div>

            <div class="mb-6 bg-slate-50 p-2 rounded-lg border border-slate-100 flex justify-between items-center text-xs">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-server text-gray-400"></i>
                    <span class="text-gray-500 font-medium">Server:</span>
                    <span id="server-location" class="font-bold text-slate-700">Ready</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500 font-medium hidden sm:inline">Provider:</span>
                    <span class="font-bold text-slate-700">Cloudflare</span>
                </div>
            </div>

            <div class="flex flex-col md:flex-row items-center md:space-x-8 space-y-6 md:space-y-0 h-full justify-center pb-2">
                <div class="relative w-44 h-44 flex-shrink-0" id="gauge-container">
                    <svg class="w-full h-full transform -rotate-90 gauge-svg" viewBox="0 0 36 36">
                        <path class="gauge-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="2.5" />
                        <path id="speed-gauge" class="gauge-fill" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="2.5" stroke-dasharray="0, 100" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span class="text-4xl font-bold text-slate-800" id="gauge-value">0</span>
                        <span class="text-xs text-gray-400 uppercase mt-1 font-semibold" id="gauge-label">Start</span>
                    </div>
                </div>

                <div class="flex-1 w-full space-y-4">
                    <div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded">
                        <span class="text-xs text-gray-500 font-semibold uppercase">Status</span>
                        <span class="text-xs font-bold text-emerald-600" id="test-state">Idle</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                        <span class="text-sm text-gray-500"><i class="fas fa-exchange-alt text-xs mr-2"></i>Latency</span>
                        <span class="font-mono font-bold text-slate-700" id="ping-value">-- ms</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                        <span class="text-sm text-gray-500"><i class="fas fa-arrow-down text-xs mr-2 text-blue-500"></i>Download</span>
                        <span class="font-mono font-bold text-blue-600" id="dl-final">-- Mbps</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                        <span class="text-sm text-gray-500"><i class="fas fa-arrow-up text-xs mr-2 text-purple-500"></i>Upload</span>
                        <span class="font-mono font-bold text-purple-600" id="ul-final">-- Mbps</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden mt-2">
                        <div class="bg-emerald-500 h-1.5 rounded-full transition-all duration-200" id="speed-progress" style="width: 0%"></div>
                    </div>

                    <div class="mt-4 flex space-x-2">
                        <button id="btn-card-speed" onclick="runHighPerformanceTest()" class="w-full px-4 py-2 bg-emerald-600 text-white rounded-lg shadow hover:bg-emerald-700 transition flex items-center justify-center font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-play mr-2"></i> Start Speedtest
                        </button>
                        <button id="btn-stop-speed" onclick="stopSpeedTest()" class="hidden w-full px-4 py-2 bg-red-50 text-red-600 rounded-lg shadow-sm border border-red-100 hover:bg-red-100 transition flex items-center justify-center font-bold">
                            <i class="fas fa-stop mr-2"></i> Stop
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-6 border-t-4 border-gray-500 md:col-span-4">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wider">Previous Tests</h3>
                    <p class="text-xs text-gray-400 mt-1">Saved locally via Cookies</p>
                </div>
                <div class="flex space-x-2 text-xs items-center">
                    <div class="relative group mr-2">
                        <select id="history-limit-select" onchange="updateHistoryLimit()" class="bg-gray-50 border border-gray-200 text-gray-600 text-[10px] font-semibold uppercase tracking-wide rounded px-2 py-1.5 focus:outline-none focus:border-blue-300 cursor-pointer">
                            <option value="5">Keep 5</option>
                            <option value="10">Keep 10</option>
                            <option value="25">Keep 25</option>
                            <option value="50" selected>All (Max 50)</option>
                        </select>
                    </div>

                    <span id="consent-status" class="px-2 py-1.5 rounded bg-gray-100 text-gray-500 font-semibold">Checking...</span>
                    <button id="btn-enable-history" onclick="showConsentModal()" class="hidden px-3 py-1.5 bg-blue-50 text-blue-600 rounded border border-blue-200 hover:bg-blue-100 font-semibold transition"><i class="fas fa-check-circle mr-1"></i> Enable</button>
                    <button id="btn-disable-history" onclick="disableHistory()" class="hidden px-3 py-1.5 bg-gray-100 text-gray-600 rounded border border-gray-300 hover:bg-gray-200 font-semibold transition"><i class="fas fa-ban mr-1"></i> Disable</button>
                    <button id="btn-clear-history" onclick="clearHistory()" class="hidden text-red-500 hover:text-red-700 hover:underline px-2"><i class="fas fa-trash-alt mr-1"></i> Clear</button>
                </div>
            </div>
            <div class="overflow-x-auto overflow-y-auto max-h-80 custom-scroll border border-gray-50 rounded-lg">
                <table class="min-w-full text-sm text-left relative">
                    <thead class="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="px-4 py-2">Time</th>
                        <th class="px-4 py-2">IP Address</th>
                        <th class="px-4 py-2">ISP</th>
                        <th class="px-4 py-2">Server</th>
                        <th class="px-4 py-2">Latency</th>
                        <th class="px-4 py-2">Download</th>
                        <th class="px-4 py-2">Upload</th>
                    </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-gray-100 text-slate-700 bg-white"></tbody>
                </table>
            </div>
        </div>

    </div>

    <footer class="mt-12 mb-6 text-center border-t border-gray-200 pt-6">
        <p class="text-sm text-gray-400 flex justify-center items-center gap-2">
            &copy; <span id="year"></span> net.bunorden.com.
            <a href="mailto:contact@bunorden.com" class="text-slate-500 hover:text-slate-800 hover:underline transition font-medium">Contact</a>
            <span class="text-gray-300">|</span>
            <button onclick="openPrivacy()" class="text-slate-500 hover:text-slate-800 hover:underline transition font-medium">Privacy Policy</button>
        </p>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // --- 0. UI & PRIVACY LOGIC ---
    document.getElementById('year').innerText = new Date().getFullYear();
    document.getElementById('policy-date').innerText = new Date().toLocaleDateString();

    function openPrivacy() {
        const modal = document.getElementById('privacy-modal');
        const content = document.getElementById('privacy-content');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closePrivacy() {
        const modal = document.getElementById('privacy-modal');
        const content = document.getElementById('privacy-content');
        modal.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    // --- NEW: TIMEZONE MODAL LOGIC ---
    function showTzModal() {
        const m = document.getElementById('tz-modal');
        const content = m.querySelector('div'); // inner container

        // Calculate Data
        const d = new Date();
        const sysRegion = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const offset = -d.getTimezoneOffset();
        const sign = offset >= 0 ? '+' : '-';
        const pad = n => String(Math.floor(Math.abs(n))).padStart(2, '0');
        const utcStr = `UTC${sign}${pad(offset/60)}:${pad(offset%60)}`;

        // Populate
        document.getElementById('modal-utc').innerText = utcStr;
        document.getElementById('modal-region').innerText = sysRegion;
        document.getElementById('modal-local').innerText = d.toString();
        document.getElementById('modal-global').innerText = d.toUTCString();

        // --- FILTER & DISPLAY REGIONS WITH SAME OFFSET ---
        const listEl = document.getElementById('modal-all-regions');
        const listTitle = document.getElementById('modal-regions-title');
        listEl.innerHTML = '';

        if (typeof Intl.supportedValuesOf !== 'undefined') {
            try {
                // Helper to get consistent offset string (e.g. "GMT+09:00")
                const getOffsetStr = (z) => {
                    try {
                        return new Intl.DateTimeFormat('en-US', { timeZone: z, timeZoneName: 'longOffset' })
                            .formatToParts(d)
                            .find(p => p.type === 'timeZoneName').value;
                    } catch(e) { return ''; }
                };

                const targetOffsetStr = getOffsetStr(sysRegion);
                const allTz = Intl.supportedValuesOf('timeZone');

                // Filter
                const matching = allTz.filter(tz => getOffsetStr(tz) === targetOffsetStr);

                // Update Title
                if(listTitle) listTitle.innerText = `Regions matching ${utcStr} (${matching.length})`;

                const frag = document.createDocumentFragment();
                matching.forEach(tz => {
                    const li = document.createElement('li');
                    li.textContent = tz;
                    // Highlight the current one
                    if(tz === sysRegion) {
                        li.className = "font-bold text-blue-600 bg-blue-50 px-1 rounded -ml-1";
                    }
                    frag.appendChild(li);
                });
                listEl.appendChild(frag);
            } catch(e) {
                listEl.innerHTML = '<li>Error calculating offsets.</li>';
                console.error(e);
            }
        } else {
            listEl.innerHTML = '<li>Not supported in this browser.</li>';
        }

        // Animate
        m.classList.remove('hidden');
        setTimeout(() => {
            m.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closeTz() {
        const m = document.getElementById('tz-modal');
        const content = m.querySelector('div');
        m.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            m.classList.add('hidden');
        }, 300);
    }

    // --- NEW: USER AGENT MODAL LOGIC (Renamed to OS Modal) ---
    function showOsModal() {
        const m = document.getElementById('os-modal');
        const content = m.querySelector('div');
        m.classList.remove('hidden');
        setTimeout(() => {
            m.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closeOsModal() {
        const m = document.getElementById('os-modal');
        const content = m.querySelector('div');
        m.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            m.classList.add('hidden');
        }, 300);
    }

    // --- NEW: BROWSER MODAL LOGIC ---
    function showBrowserModal() {
        const m = document.getElementById('browser-modal');
        const content = m.querySelector('div');
        m.classList.remove('hidden');
        setTimeout(() => {
            m.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closeBrowserModal() {
        const m = document.getElementById('browser-modal');
        const content = m.querySelector('div');
        m.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            m.classList.add('hidden');
        }, 300);
    }

    // --- NEW: VPN MODAL LOGIC ---
    function showVpnModal() {
        const m = document.getElementById('vpn-modal');
        const content = m.querySelector('div');
        m.classList.remove('hidden');
        setTimeout(() => {
            m.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closeVpnModal() {
        const m = document.getElementById('vpn-modal');
        const content = m.querySelector('div');
        m.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            m.classList.add('hidden');
        }, 300);
    }

    // --- NEW: SPEED MODAL LOGIC ---
    let lastSpeedData = null; // Store results

    function showSpeedModal() {
        const m = document.getElementById('speed-modal');
        const content = m.querySelector('div');

        // Populate if data exists, otherwise show defaults
        if(lastSpeedData) {
            document.getElementById('modal-dl').innerText = lastSpeedData.dl;
            document.getElementById('modal-ul').innerText = lastSpeedData.ul;
            document.getElementById('modal-ping').innerText = lastSpeedData.ping + " ms";
            document.getElementById('modal-jitter').innerText = lastSpeedData.jitter + " ms";

            // Calculate Grade
            const dlVal = parseFloat(lastSpeedData.dl);
            const pingVal = parseInt(lastSpeedData.ping);
            let grade = "F";
            let color = "text-red-500";

            if(dlVal > 500 && pingVal < 20) { grade="A+"; color="text-emerald-500"; }
            else if(dlVal > 100 && pingVal < 50) { grade="A"; color="text-emerald-500"; }
            else if(dlVal > 50 && pingVal < 100) { grade="B"; color="text-blue-500"; }
            else if(dlVal > 10 && pingVal < 150) { grade="C"; color="text-orange-500"; }
            else if(dlVal > 1) { grade="D"; color="text-orange-600"; }

            const gradeEl = document.getElementById('net-grade');
            gradeEl.innerText = grade;
            gradeEl.className = `text-3xl font-black ${color}`;

            // Capabilities
            document.getElementById('badge-4k').className = (dlVal > 25) ? "px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-[10px] font-bold" : "opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold";
            document.getElementById('badge-1080p').className = (dlVal > 5) ? "px-2 py-1 bg-blue-100 text-blue-700 rounded text-[10px] font-bold" : "opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold";
            document.getElementById('badge-720p').className = (dlVal > 2) ? "px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-[10px] font-bold" : "opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold";

            document.getElementById('modal-ploss').innerText = lastSpeedData.ploss;
        }

        m.classList.remove('hidden');
        setTimeout(() => {
            m.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closeSpeedModal() {
        const m = document.getElementById('speed-modal');
        const content = m.querySelector('div');
        m.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            m.classList.add('hidden');
        }, 300);
    }

    // --- 1. COOKIE LOGIC ---
    function setCookie(n, v, d) { let e=""; if(d){const dt=new Date();dt.setTime(dt.getTime()+(d*24*60*60*1000));e="; expires="+dt.toUTCString();} document.cookie=n+"="+(v||"")+e+"; path=/"; }
    function getCookie(n) { const ne=n+"="; const ca=document.cookie.split(';'); for(let i=0;i<ca.length;i++){ let c=ca[i]; while(c.charAt(0)==' ') c=c.substring(1,c.length); if(c.indexOf(ne)==0) return c.substring(ne.length,c.length); } return null; }

    function showConsentModal() { const m=document.getElementById('cookie-modal'); const c=document.getElementById('cookie-content'); m.classList.remove('hidden'); setTimeout(()=>{m.classList.remove('opacity-0');c.classList.remove('scale-95');},50); }
    function hideConsentModal() { const m=document.getElementById('cookie-modal'); m.classList.add('opacity-0'); setTimeout(()=>{m.classList.add('hidden');},300); }
    function handleConsent(a) { const v=a?'accepted':'declined'; setCookie('speedtest_consent',v,365); hideConsentModal(); if(!a){ setCookie('speedtest_history',"",-1); } updateConsentStatus(v); renderHistory(); }
    function disableHistory() { setCookie('speedtest_consent','declined',365); setCookie('speedtest_history',"",-1); updateConsentStatus('declined'); renderHistory(); }

    function updateConsentStatus(s) {
        const l=document.getElementById('consent-status'), be=document.getElementById('btn-enable-history'), bd=document.getElementById('btn-disable-history'), bc=document.getElementById('btn-clear-history');
        if(s==='accepted'){ l.innerText="Active"; l.className="px-2 py-1.5 rounded bg-emerald-100 text-emerald-600 font-bold"; be.classList.add('hidden'); bd.classList.remove('hidden'); bc.classList.remove('hidden'); }
        else { l.innerText="Disabled"; l.className="px-2 py-1.5 rounded bg-gray-100 text-gray-500 font-bold"; be.classList.remove('hidden'); bd.classList.add('hidden'); bc.classList.add('hidden'); }
    }

    // --- NEW: HISTORY LIMIT LOGIC ---
    function getHistoryLimit() {
        const el = document.getElementById('history-limit-select');
        if(el) return parseInt(el.value);
        const c = getCookie('history_limit_val');
        return c ? parseInt(c) : 50; // Default to Max/All
    }

    function updateHistoryLimit() {
        const val = document.getElementById('history-limit-select').value;
        setCookie('history_limit_val', val, 365);
        trimHistory(parseInt(val));
    }

    function trimHistory(limit) {
        let h=getCookie('speedtest_history');
        try{h=h?JSON.parse(h):[];}catch(e){h=[];}
        if(h.length > limit) {
            h = h.slice(0, limit);
            setCookie('speedtest_history',JSON.stringify(h),30);
            renderHistory();
        }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
        const c=getCookie('speedtest_consent');
        if(!c){showConsentModal(); updateConsentStatus(null);}else{updateConsentStatus(c);}

        // Initialize Dropdown
        const lim = getCookie('history_limit_val');
        if(lim) document.getElementById('history-limit-select').value = lim;

        renderHistory();
    });

    // UPDATED SAVE RESULT FUNCTION
    function saveResult(p, d, u, s, prov) { // Added 'prov' (Provider) parameter
        if (getCookie('speedtest_consent') !== 'accepted') return;
        let h = getCookie('speedtest_history');
        try { h = h ? JSON.parse(h) : []; } catch (e) { h = []; }

        const ip = document.getElementById('ipv4-display').innerText || '--';
        const isp = document.getElementById('isp-display').innerText || '--';

        const dateObj = new Date();
        const f = (x) => String(x).padStart(2, '0');
        const timeStr = `${f(dateObj.getHours())}:${f(dateObj.getMinutes())}`;
        const dateStr = `${f(dateObj.getDate())}/${f(dateObj.getMonth() + 1)}/${dateObj.getFullYear()}`;

        const offset = -dateObj.getTimezoneOffset();
        const sign = offset >= 0 ? '+' : '-';
        const pad = n => String(Math.floor(Math.abs(n))).padStart(2, '0');
        const utcStr = `UTC${sign}${pad(offset / 60)}:${pad(offset % 60)}`;

        const fullDate = `${timeStr} ${dateStr} (${utcStr})`;

        // Store Provider AND Server
        h.unshift({
            date: fullDate,
            ping: p,
            dl: d,
            ul: u,
            ip: ip,
            isp: isp,
            server: s || 'Unknown',
            provider: prov || 'Unknown' // New Field
        });

        const limit = getHistoryLimit();
        while (h.length > limit) h.pop();

        setCookie('speedtest_history', JSON.stringify(h), 30);
        renderHistory();
    }

    function clearHistory(){ setCookie('speedtest_history',"",-1); renderHistory(); }

    // UPDATED RENDER HISTORY FUNCTION
    function renderHistory() {
        const tb = document.getElementById('history-table-body'), c = getCookie('speedtest_consent');
        if (c !== 'accepted') {
            tb.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-400"><p class="italic mb-2">History disabled.</p><button onclick="showConsentModal()" class="text-blue-500 underline font-medium">Enable</button></td></tr>`;
            return;
        }
        let h = getCookie('speedtest_history');
        try { h = h ? JSON.parse(h) : []; } catch (e) { h = []; }

        if (h.length === 0) {
            tb.innerHTML = `<tr><td colspan="7" class="px-4 py-4 text-center text-gray-400 italic">No history found.</td></tr>`;
            return;
        }

        let ht = '';
        h.forEach(i => {
            // Fallback for old records that didn't have a provider saved
            const providerDisplay = i.provider ? i.provider : 'Cloudflare';

            ht += `<tr class="hover:bg-gray-50 transition">
                <td class="px-4 py-2 font-mono text-gray-500 text-xs">${i.date}</td>
                <td class="px-4 py-2 font-mono text-xs text-slate-600">${i.ip || '-'}</td>
                <td class="px-4 py-2 text-xs text-slate-600 max-w-[120px] truncate" title="${i.isp || ''}">${i.isp || '-'}</td>

                <td class="px-4 py-2 text-xs">
                    <div class="font-bold text-slate-700">${providerDisplay}</div>
                    <div class="text-[10px] text-gray-400 font-mono">${i.server || '-'}</div>
                </td>

                <td class="px-4 py-2 font-bold">${i.ping}</td>
                <td class="px-4 py-2 font-bold text-blue-600">${i.dl}</td>
                <td class="px-4 py-2 font-bold text-purple-600">${i.ul}</td>
            </tr>`;
        });
        tb.innerHTML = ht;
    }

    // --- 2. MULTI-THREADED SPEEDTEST ENGINE ---
    function updateGauge(v, l, u=false) {
        const gv=document.getElementById('gauge-value'), gl=document.getElementById('gauge-label'), gf=document.getElementById('speed-gauge');
        gv.innerText=v; gl.innerText=l; gf.style.stroke=u?"#9333ea":"#10b981";
        let p=(v/100)*100; if(p>100)p=100; gf.style.strokeDasharray=`${p}, 100`;
    }

    // --- ANIMATION TOGGLE LOGIC ---
    let animationEnabled = true;
    // Note: Toggle functionality removed from UI, defaulting to true.

    // --- STOP SPEEDTEST LOGIC ---
    let speedTestAbortController = null;

    async function fetchStream(url, duration, updateCallback, signal) {
        const start = performance.now();
        let loaded = 0;
        try {
            const response = await fetch(url, { signal });
            const reader = response.body.getReader();
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                loaded += value.length;
                if (performance.now() - start > duration) { reader.cancel(); break; }
                updateCallback(loaded);
            }
        } catch (e) {
            if (e.name !== 'AbortError') throw e;
        }
        return loaded;
    }

    function stopSpeedTest() {
        if(speedTestAbortController) {
            speedTestAbortController.abort();
            speedTestAbortController = null;
            document.getElementById('test-state').innerText = "Stopped";
            document.getElementById('test-state').className = "text-xs font-bold text-red-500";
            document.getElementById('speed-status-icon').className = "p-2 bg-gray-50 rounded-lg text-gray-400";
            document.getElementById('speed-gauge').classList.remove('gauge-pulse');
            document.getElementById('gauge-container').classList.remove('active-anim');
        }
    }

    async function runHighPerformanceTest() {
        // --- SETUP ---
        const btnStart = document.getElementById('btn-card-speed');
        const btnStop = document.getElementById('btn-stop-speed');
        btnStart.classList.add('hidden');
        btnStop.classList.remove('hidden');

        speedTestAbortController = new AbortController();
        const signal = speedTestAbortController.signal;

        const status = document.getElementById('test-state');
        const bar = document.getElementById('speed-progress');
        const icon = document.getElementById('speed-status-icon');
        const dlEl = document.getElementById('dl-final');
        const ulEl = document.getElementById('ul-final');
        const pgEl = document.getElementById('ping-value');
        const serverLoc = document.getElementById('server-location');
        const gaugeFill = document.getElementById('speed-gauge');
        const gaugeContainer = document.getElementById('gauge-container');

        // Reset
        dlEl.innerText = "-- Mbps"; ulEl.innerText = "-- Mbps"; bar.style.width = "0%";
        updateGauge(0, "Ready");

        if (animationEnabled) {
            icon.className = "p-2 bg-emerald-50 rounded-lg text-emerald-600 blink";
            gaugeFill.classList.add('gauge-pulse');
            gaugeContainer.classList.add('active-anim');
        }

        function calculateSpeed(currentBytes, startBytes, currentTime, startTime) {
            const bytesDiff = currentBytes - startBytes;
            const timeDiff = (currentTime - startTime) / 1000;
            if (timeDiff <= 0) return 0;
            return ((bytesDiff * 8) / timeDiff / 1024 / 1024).toFixed(1);
        }

        let fP = "--", fD = "--", fU = "--";
        let jitterVal = "0";
        let detectedServer = "Unknown";
        const detectedProvider = "Cloudflare"; // Hardcoded Provider Name

        try {
            // PHASE 1: LATENCY
            status.innerText = "Measuring Latency...";
            const pings = [];
            for (let i = 0; i < 10; i++) {
                try {
                    const pS = performance.now();
                    await fetch('https://speed.cloudflare.com/cdn-cgi/trace?r=' + Math.random(), { signal });
                    const pE = performance.now();
                    pings.push(pE - pS);
                } catch (e) { if (signal.aborted) throw e; }
            }

            if (pings.length > 0) {
                pings.sort((a, b) => a - b);
                if (pings.length > 4) { pings.pop(); pings.shift(); }
                const avgPing = pings.reduce((a, b) => a + b, 0) / pings.length;
                const variance = pings.reduce((a, b) => a + Math.pow(b - avgPing, 2), 0) / pings.length;
                jitterVal = Math.sqrt(variance).toFixed(1);
                fP = Math.round(avgPing);
                pgEl.innerText = fP + " ms";
            }

            // GET SERVER LOCATION
            await fetch('https://speed.cloudflare.com/cdn-cgi/trace', { signal })
                .then(r => r.text())
                .then(t => {
                    const loc = t.match(/loc=(.+)/)?.[1] || "UNK";
                    const colo = t.match(/colo=(.+)/)?.[1] || "UNK";
                    detectedServer = `${colo} (${loc})`;
                    serverLoc.innerHTML = `${colo} <span class="text-gray-400 font-normal">(${loc})</span>`;
                }).catch(() => {});

            // PHASE 2: DOWNLOAD
            status.innerText = "Downloading (Warm-up)...";
            const dlDuration = 10000;
            const warmUpTime = 2000;
            const dlUrl = "https://speed.cloudflare.com/__down?bytes=50000000";
            let dlStartTime = performance.now();
            let dlTotalBytes = 0;
            let dlWarmUpDone = false;
            let dlBytesAtWarmUp = 0;
            let dlTimeAtWarmUp = 0;

            const dlPromises = Array(6).fill(0).map(async () => {
                while ((performance.now() - dlStartTime) < dlDuration) {
                    try {
                        const response = await fetch(dlUrl + "&r=" + Math.random(), { signal });
                        const reader = response.body.getReader();
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            dlTotalBytes += value.length;
                            if ((performance.now() - dlStartTime) > dlDuration) { reader.cancel(); return; }
                        }
                    } catch (e) { return; }
                }
            });

            const dlTimer = setInterval(() => {
                if (signal.aborted) { clearInterval(dlTimer); return; }
                const now = performance.now();
                const elapsed = now - dlStartTime;
                if (!dlWarmUpDone && elapsed > warmUpTime) {
                    dlWarmUpDone = true;
                    dlBytesAtWarmUp = dlTotalBytes;
                    dlTimeAtWarmUp = now;
                    status.innerText = "Downloading (Measuring)...";
                }
                if (elapsed > 500) {
                    let currentSpeed = 0;
                    if (dlWarmUpDone) currentSpeed = calculateSpeed(dlTotalBytes, dlBytesAtWarmUp, now, dlTimeAtWarmUp);
                    else currentSpeed = calculateSpeed(dlTotalBytes, 0, now, dlStartTime);
                    updateGauge(currentSpeed, "Mbps (Down)");
                    bar.style.width = Math.min((elapsed / dlDuration) * 50, 50) + "%";
                }
            }, 100);

            await Promise.all(dlPromises);
            clearInterval(dlTimer);
            if (signal.aborted) throw new Error('Aborted');

            fD = calculateSpeed(dlTotalBytes, dlBytesAtWarmUp, performance.now(), dlTimeAtWarmUp) + " Mbps";
            dlEl.innerText = fD;

            // PHASE 3: UPLOAD
            status.innerText = "Uploading (Warm-up)...";
            updateGauge(0, "Mbps (Up)", true);
            const ulDuration = 8000;
            const upChunkSize = 2 * 1024 * 1024;
            const blob = new Blob([new Uint8Array(upChunkSize)]);
            let ulStartTime = performance.now();
            let ulTotalBytes = 0;
            let ulWarmUpDone = false;
            let ulBytesAtWarmUp = 0;
            let ulTimeAtWarmUp = 0;

            const ulPromises = Array(4).fill(0).map(async () => {
                while ((performance.now() - ulStartTime) < ulDuration) {
                    try {
                        await fetch("https://speed.cloudflare.com/__up", { method: "POST", body: blob, signal });
                        ulTotalBytes += upChunkSize;
                    } catch (e) { return; }
                }
            });

            const ulTimer = setInterval(() => {
                if (signal.aborted) { clearInterval(ulTimer); return; }
                const now = performance.now();
                const elapsed = now - ulStartTime;
                if (!ulWarmUpDone && elapsed > warmUpTime) {
                    ulWarmUpDone = true;
                    ulBytesAtWarmUp = ulTotalBytes;
                    ulTimeAtWarmUp = now;
                    status.innerText = "Uploading (Measuring)...";
                }
                if (elapsed > 500) {
                    let currentSpeed = 0;
                    if (ulWarmUpDone) currentSpeed = calculateSpeed(ulTotalBytes, ulBytesAtWarmUp, now, ulTimeAtWarmUp);
                    else currentSpeed = calculateSpeed(ulTotalBytes, 0, now, ulStartTime);
                    updateGauge(currentSpeed, "Mbps (Up)", true);
                    bar.style.width = 50 + Math.min((elapsed / ulDuration) * 50, 50) + "%";
                }
            }, 100);

            await Promise.all(ulPromises);
            clearInterval(ulTimer);
            if (signal.aborted) throw new Error('Aborted');

            if (ulTotalBytes > 0) {
                fU = calculateSpeed(ulTotalBytes, ulBytesAtWarmUp, performance.now(), ulTimeAtWarmUp) + " Mbps";
                ulEl.innerText = fU;
            } else {
                fU = "Failed (CORS)";
                ulEl.innerText = "Blocked";
            }

            status.innerText = "Complete";
            status.className = "text-xs font-bold text-emerald-600";
            bar.style.width = "100%";
            icon.className = "p-2 bg-emerald-50 rounded-lg text-emerald-600";
            gaugeFill.classList.remove('gauge-pulse');
            gaugeContainer.classList.remove('active-anim');

            lastSpeedData = { dl: fD, ul: fU, ping: fP, jitter: jitterVal, ploss: "0% (Estimated)" };

            // PASS DETECTED PROVIDER TO SAVE FUNCTION
            saveResult(fP + " ms", fD, fU, detectedServer, detectedProvider);

        } catch (e) {
            if (e.message === 'Aborted' || e.name === 'AbortError') {
                status.innerText = "Stopped";
                status.className = "text-xs font-bold text-orange-500";
            } else {
                console.error(e);
                status.innerText = "Error";
                status.className = "text-xs font-bold text-red-600";
            }
            icon.className = "p-2 bg-gray-50 rounded-lg text-gray-400";
            gaugeFill.classList.remove('gauge-pulse');
            gaugeContainer.classList.remove('active-anim');
        } finally {
            btnStart.classList.remove('hidden');
            btnStop.classList.add('hidden');
        }
    }

    // --- 3. VPN & SYSTEM UTILS ---

    // --- UPDATED: Comprehensive VPN/Hosting ASN Database ---
    const KNOWN_VPN_ASNS = new Set([
        // --- MAJOR VPN BRANDS (Exclusive ASNs) ---
        209854, // Surfshark (Cyberzone)
        216025, // Mullvad VPN
        39351,  // Mullvad (31173 Services AB)
        209103, 62371, 199218, // ProtonVPN (Proton AG)
        136787, 147049, 141039, 207137, // NordVPN (Packethub S.A.)
        137409, // ExpressVPN (LogicWeb/GSL)

        // --- COMMON VPN INFRASTRUCTURE (Shared Providers) ---
        // These are used by Nord, Express, IPVanish, CyberGhost, etc.
        9009,   // M247 (Major VPN Transit)
        60068,  // Datacamp Limited / CDN77 (Major VPN Transit)
        212238, // Datacamp Limited
        62240,  // Clouvider (ExpressVPN/Others)
        20473,  // The Constant Company (Vultr)
        63949,  // Akamai (Linode)
        14061,  // DigitalOcean
        16509, 14618, // Amazon AWS
        15169, 396982, // Google Cloud
        8075,   // Microsoft Azure
        24940,  // Hetzner Online
        16276,  // OVH SAS
        13335,  // Cloudflare (WARP)

        // --- ADDITIONAL HOSTING/PRIVACY NETWORKS ---
        53667,  // FranTech (BuyVM)
        202425, // IP Volume
        132203, // Tencent Cloud
        49335,  // Rayo Byte
        31898,  // Oracle Cloud
        40021,  // Contabo
        262287, // Latitude.sh
        396356, // Latitude.sh
        21859,  // Zenlayer
        203020, // HostRoyale
        22363,  // Powerhouse Management
        136557  // Host Universal
    ]);

    // --- UPDATED: Precision Brand Mapping (Clean Labels) ---
    // Format: "Likely [VPN Names] - [ASN/Infra]"
    // --- UPDATED: Precision Brand Mapping ---
    // Format: "Likely [VPN Names] - [ASN/Infra]"
    const VPN_BRAND_MAP = [
        // 1. SPECIFIC COMMERCIAL BRANDS (Direct Match)
        { keys: ['proton ag', 'protonvpn'], label: 'Likely ProtonVPN - Proton AG' },
        { keys: ['mullvad', '31173 services', 'amnezia'], label: 'Likely Mullvad - 31173 Services' },
        { keys: ['cyberzone', 'surfshark'], label: 'Likely Surfshark - Cyberzone' },
        { keys: ['packethub', 'nordvpn'], label: 'Likely NordVPN - Packethub' },
        { keys: ['expressvpn', 'expressnetw'], label: 'Likely ExpressVPN - ExpressNetw' },
        { keys: ['logicweb'], label: 'Likely ExpressVPN - LogicWeb' },
        { keys: ['windscribe'], label: 'Likely Windscribe - Windscribe' },
        { keys: ['hide.me', 'hide me'], label: 'Likely Hide.me - Hide.me' },
        { keys: ['ivpn'], label: 'Likely IVPN - IVPN' },
        { keys: ['ovpn'], label: 'Likely OVPN - OVPN' },

        // --- UPDATED: StrongVPN / IPVanish / Speedtest VPN Group ---
        // These providers all share the NetProtect / Highwinds / Stackpath infrastructure.
        { keys: ['strong technology', 'strongvpn', 'ipvanish', 'netprotect', 'highwinds', 'stackpath', 'performive'], label: 'Likely StrongVPN/IPVanish/Speedtest VPN - NetProtect' },

        // 2. SHARED INFRASTRUCTURE (The "Big 3" Datacenters)
        { keys: ['m247', 'm europe', 'ipxo'], label: 'Likely Nord/Surfshark/Proton - M247' },
        { keys: ['datacamp', 'cdn77', 'datapacket'], label: 'Likely Surfshark/PIA - Datacamp' },
        { keys: ['tzulo', 'gsl networks'], label: 'Likely PureVPN/CyberGhost - GSL' },
        { keys: ['clouvider'], label: 'Likely ExpressVPN/FastestVPN - Clouvider' },

        // 3. GENERIC CLOUD/VPS
        { keys: ['cloudflare', 'warp'], label: 'Likely WARP/Apple iCloud Private Relay - Cloudflare' },

        { keys: ['google', 'google llc'], label: 'Likely Google One VPN - Google Cloud' },
        { keys: ['constant', 'vultr', 'choopa'], label: 'Likely IPVanish/Self-Hosted - Vultr' },
        { keys: ['digitalocean'], label: 'Likely Self-Hosted VPN - DigitalOcean' },
        { keys: ['linode', 'akamai'], label: 'Likely Self-Hosted VPN - Linode' },
        { keys: ['ovh', 'ovh sas'], label: 'Likely Self-Hosted VPN - OVH' },
        { keys: ['hetzner'], label: 'Likely Self-Hosted VPN - Hetzner' },
        { keys: ['amazon', 'aws'], label: 'Likely AWS VPN - AWS' },
        { keys: ['microsoft', 'azure'], label: 'Likely Azure VPN - Azure' },

        // 4. ANONYMITY NETWORKS
        { keys: ['tor exit', 'tor project', 'onion'], label: 'Tor Network - Tor Exit Node' }
    ];

    // Priority 2: Generic list of known providers/terms for regex matching
    const PROVIDER_NAMES = [
        'cloudflare', 'google', 'amazon', 'aws', 'microsoft', 'azure',
        'digitalocean', 'hetzner', 'ovh', 'expressvpn',
        'nordvpn', 'proton', 'surfshark', 'mullvad',
        'zenlayer', 'leaseweb', 'hostinger',
        'windscribe', 'tunnelbear', 'vyprvpn', 'purevpn', 'ipvanish',
        'hotspot shield', 'zenmate', 'hidemyass', 'hma', 'private internet access',
        'pia', 'cyberghost', 'strongvpn', 'fastestvpn', 'ivacy', 'veepn', 'torguard',
        'airvpn', 'perfectprivacy', 'cactusvpn', 'ovpn', 'hide.me',
        'privatevpn', 'protonvpn', 'vultr', 'linode', 'choopa', 'performive',
        'shock hosting', 'teraswitch', 'melbicom', 'packethub', 'datacamp'
    ];

    // Compiled Regex for O(1) matching of strings
    const VPN_REGEX = new RegExp(PROVIDER_NAMES.join('|'), 'i');
    const GENERIC_REGEX = /vpn|proxy|hosting|cloud|datacenter|vps|server|transit|colo/i;

    function detectVPN(ipTz, ipUtc, isp, countryCode, org, asn) {
        const vpnEl = document.getElementById('vpn-status');
        const detailEl = document.getElementById('vpn-details');
        const badgeEl = document.getElementById('vpn-risk-badge');
        const fraudEl = document.getElementById('vpn-fraud-score');
        const providerNameEl = document.getElementById('vpn-provider-name'); // Targets the new section

        // System UTC Calculation
        const d = new Date();
        const offset = -d.getTimezoneOffset();
        const sign = offset >= 0 ? '+' : '-';
        const pad = n => String(Math.floor(Math.abs(n))).padStart(2, '0');
        const sysUtcStr = `UTC${sign}${pad(offset/60)}:${pad(offset%60)}`;
        const ipUtcStr = `UTC${ipUtc}`;

        let score = 0;
        const reasons = [];

        // Fast Prep
        const asnNum = parseInt(asn);
        const combinedName = (isp + " " + org + " " + asn).toLowerCase();

        // 1. Check Priority Mappings first (Custom Branding)
        let matchedBrand = null;
        for (const brand of VPN_BRAND_MAP) {
            if (brand.keys.some(k => combinedName.includes(k))) {
                matchedBrand = brand.label;
                score += 50;
                reasons.push(`Known Infra Match`);
                document.getElementById('icon-isp').className = "fas fa-exclamation-triangle text-red-500";
                document.getElementById('desc-isp').innerText = `Infra Matched: ${brand.keys[0]}`;
                break;
            }
        }

        let ispFlagged = !!matchedBrand;

        // 2. ASN Check
        if (!ispFlagged && !isNaN(asnNum) && KNOWN_VPN_ASNS.has(asnNum)) {
            score += 50;
            reasons.push(`ASN Match: ${asnNum}`);
            ispFlagged = true;
            document.getElementById('icon-isp').className = "fas fa-exclamation-triangle text-red-500";
            document.getElementById('desc-isp').innerText = `Flagged ASN: ${asnNum}`;
        }

        // 3. String Match
        if (!ispFlagged && VPN_REGEX.test(combinedName)) {
            score += 50;
            const match = combinedName.match(VPN_REGEX)[0];
            const formattedName = match.charAt(0).toUpperCase() + match.slice(1);
            matchedBrand = `${formattedName} Detected`;

            reasons.push(`Provider Match: ${match}`);
            ispFlagged = true;
            document.getElementById('icon-isp').className = "fas fa-exclamation-triangle text-red-500";
            document.getElementById('desc-isp').innerText = `Matched: ${formattedName}`;
        }

        // 4. Generic Heuristics
        if (!ispFlagged) {
            if (GENERIC_REGEX.test(combinedName)) {
                score += 20;
                reasons.push("Generic Hosting Keyword");
                document.getElementById('icon-isp').className = "fas fa-exclamation-circle text-orange-500";
                document.getElementById('desc-isp').innerText = "Generic Hosting Keyword";
            } else {
                document.getElementById('icon-isp').className = "fas fa-check-circle text-emerald-500";
                document.getElementById('desc-isp').innerText = "Residential/Standard ISP";
            }
        }

        // 5. Timezone Check
        if (ipUtcStr !== sysUtcStr) {
            score += 20;
            reasons.push("Timezone Mismatch");
            document.getElementById('icon-tz').className = "fas fa-exclamation-circle text-orange-500";
            document.getElementById('desc-tz').innerText = `IP: ${ipUtcStr} vs Sys: ${sysUtcStr}`;
        } else {
            document.getElementById('icon-tz').className = "fas fa-check-circle text-emerald-500";
            document.getElementById('desc-tz').innerText = "Matched";
        }

        // 6. Language Check
        const browserLang = navigator.language || "en";
        document.getElementById('icon-lang').className = "fas fa-info-circle text-blue-400";
        document.getElementById('desc-lang').innerText = `Browser: ${browserLang}, IP: ${countryCode}`;

        // 7. TOR Check
        if (/tor exit|tor project|onion/i.test(combinedName)) {
            document.getElementById('icon-tor').className = "fas fa-exclamation-triangle text-red-500";
            document.getElementById('desc-tor').innerText = "Tor Node Confirmed";
        } else {
            document.getElementById('icon-tor').className = "fas fa-check-circle text-emerald-500";
            document.getElementById('desc-tor').innerText = "No Tor fingerprints found";
        }

        // --- SCORING & DISPLAY ---
        if (score >= 50) {
            // DETECTED (Red)
            const finalName = matchedBrand || "Detected (Unknown)";
            vpnEl.innerText = "VPN Detected";
            vpnEl.className = "text-lg font-bold mt-1 text-red-600";
            detailEl.innerHTML = "";

            providerNameEl.innerText = finalName.replace("Detected (Likely ", "").replace(")", "");
            providerNameEl.className = "font-bold text-red-600"; // Highlights name in Red

            if (matchedBrand === 'Tor Network') {
                badgeEl.innerText = "High Anonymity (Tor)";
                fraudEl.innerText = "High Risk (Tor)";
                fraudEl.className = "font-bold text-red-500";
            } else {
                badgeEl.innerText = "High Anonymity";
                badgeEl.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-emerald-100 text-emerald-700";
                fraudEl.innerText = "High Risk (Flagged)";
                fraudEl.className = "font-bold text-red-500";
            }

        } else if (score > 0) {
            // LIKELY (Orange)
            vpnEl.innerText = "Likely Detected";
            vpnEl.className = "text-lg font-bold mt-1 text-orange-500";
            detailEl.innerHTML = "";

            providerNameEl.innerText = "Generic / Datacenter";
            providerNameEl.className = "font-bold text-orange-500"; // Highlights name in Orange

            badgeEl.innerText = "Moderate Anonymity";
            badgeEl.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-orange-100 text-orange-700";
            fraudEl.innerText = "Medium Risk";
            fraudEl.className = "font-bold text-orange-500";

        } else {
            // CLEAN (Green/Black)
            vpnEl.innerText = "Not Detected";
            vpnEl.className = "text-lg font-bold mt-1 text-slate-800";
            detailEl.innerHTML = `Direct Connection`;

            providerNameEl.innerText = "Residential / None";
            providerNameEl.className = "font-bold text-emerald-600"; // Highlights name in Green

            badgeEl.innerText = "Low Anonymity";
            badgeEl.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-orange-100 text-orange-700";
            fraudEl.innerText = "Low Risk (Clean)";
            fraudEl.className = "font-bold text-emerald-500";
        }
    }
    // --- 4. DATA FETCHERS ---
    function updateTimestamp() {
        const n = new Date();
        const f = (x) => String(x).padStart(2,'0');

        // Offset
        const offset = -n.getTimezoneOffset();
        const sign = offset >= 0 ? '+' : '-';
        const pad = val => String(Math.floor(Math.abs(val))).padStart(2, '0');
        const utcStr = `UTC${sign}${pad(offset/60)}:${pad(offset%60)}`;

        document.getElementById('last-update').innerText = `${f(n.getDate())}/${f(n.getMonth()+1)}/${n.getFullYear()} , ${f(n.getHours())}:${f(n.getMinutes())}:${f(n.getSeconds())} ${utcStr}`;
    }
    setInterval(updateTimestamp,1000); updateTimestamp();

    let map;
    function initMap(lat,lng) { if(map)return; map=L.map('map',{zoomControl:false}).setView([lat,lng],13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:' OpenStreetMap'}).addTo(map); L.marker([lat,lng]).addTo(map).bindPopup("<b>IP Location</b>").openPopup(); document.getElementById('map-coords').innerText=`${lat.toFixed(4)}, ${lng.toFixed(4)}`; }

    async function fetchIPv4Data() { try{const r=await fetch('https://ipwho.is/');const d=await r.json();if(d.success){
        document.getElementById('ipv4-display').innerText=d.ip;
        document.getElementById('ipv4-loc').innerText=`${d.city}, ${d.region_code}`;

        // UPDATED: Populate 4 new fields
        document.getElementById('isp-display').innerText = d.connection.isp || "Unknown";
        document.getElementById('org-display').innerText = d.connection.org || "Unknown";
        document.getElementById('as-org-display').innerText = d.connection.org || "Unknown"; // Usually mapped to org in this API
        document.getElementById('asn-display').innerText = d.connection.asn || "--";

        document.getElementById('hostname-display').innerText=d.connection.domain||"No PTR Record";
        initMap(d.latitude,d.longitude);
        // UPDATED: Pass 'utc' field to detectVPN for offset comparison
        // Also passing org and asn now
        detectVPN(d.timezone.id, d.timezone.utc, d.connection.isp, d.country_code, d.connection.org, d.connection.asn);
    }}catch(e){document.getElementById('ipv4-display').innerText="Error";}}

    async function fetchIPv6Data() { try{const r=await fetch('https://api6.ipify.org?format=json');if(r.ok){const d=await r.json();document.getElementById('ipv6-display').innerText=d.ip;document.getElementById('ipv6-status').innerText="Active";document.getElementById('ipv6-status').className="text-xs text-emerald-500 font-bold mt-1";try{const dr=await fetch(`https://ipwho.is/${d.ip}`);const dd=await dr.json();if(dd.success){document.getElementById('ipv6-provider').innerText=dd.connection.isp||"Unknown";}else{document.getElementById('ipv6-provider').innerText="N/A";}}catch(err){document.getElementById('ipv6-provider').innerText="N/A";}}}catch(e){document.getElementById('ipv6-display').innerText="Not Detected";document.getElementById('ipv6-status').innerText="IPv4 Only";document.getElementById('ipv6-provider').innerText="N/A";}}

    // --- 5. Multi-Probing DNS Detection ---
    async function fetchDNS() {
        const list = document.getElementById('dns-list');
        const badge = document.getElementById('dns-count-badge');
        list.innerHTML = '<li class="text-sm text-gray-600 flex items-center h-full"><span class="loader mr-2"></span> Probing...</li>';

        const detected = new Set();
        // Probe 5 times to catch round-robin DNS
        const attempts = 5;
        const promises = Array(attempts).fill(0).map(async () => {
            try {
                const res = await fetch(`https://edns.ip-api.com/json?r=${Math.random()}`);
                const data = await res.json();
                return (data.dns && data.dns.ip) ? data.dns : null;
            } catch(e) { return null; }
        });

        const results = await Promise.all(promises);
        list.innerHTML = '';
        let foundCount = 0;

        results.forEach(dns => {
            if(dns && !detected.has(dns.ip)) {
                detected.add(dns.ip);
                foundCount++;

                // DATA SANITIZATION
                const geo = dns.geo ? `(${dns.geo})` : '';

                list.innerHTML += `
                        <li class="text-xl font-bold font-mono text-slate-800 mb-2 pb-2 border-b border-gray-100 last:border-0 last:pb-0 last:mb-0">
                            ${dns.ip}
                            <span class="text-xs font-sans font-normal text-gray-400 block">
                                ${geo}
                            </span>
                        </li>
                    `;
            }
        });

        if(foundCount > 0) {
            badge.innerText = `${foundCount} DETECTED`;
            badge.classList.remove('hidden');
        } else {
            list.innerHTML = '<li class="text-red-400 text-xs">Blocked / API Fail</li>';
        }
    }

    // UPDATED: WebRTC Leak Check (Smart Logic)
    // UPDATED: WebRTC Leak Check with "VPN Off" Logic
    function getWebRTCIPs() {
        const l = document.getElementById('webrtc-list');
        const icon = document.getElementById('icon-webrtc');
        const desc = document.getElementById('desc-webrtc');

        // Store unique IPs found by WebRTC
        const foundIPs = new Set();
        let isScanning = true;

        const R = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
        if (!R) {
            l.innerHTML = '<li>Unsupported</li>';
            icon.className = "fas fa-minus-circle text-gray-300";
            desc.innerText = "Browser not supported";
            return;
        }

        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        const p = new R(config);
        p.createDataChannel('');

        // 1. Gather Candidates
        p.onicecandidate = (e) => {
            if (!e.candidate) return;
            const candidate = e.candidate.candidate;
            const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/);

            if (ipMatch) {
                const ip = ipMatch[1];
                if (candidate.indexOf(".local") > -1) return; // Ignore mDNS
                if (!foundIPs.has(ip)) {
                    foundIPs.add(ip);
                    if (isScanning) {
                        l.innerHTML = ''; // Clear "Scanning..." text on first find
                        isScanning = false;
                    }
                    l.innerHTML += `<li class="text-xl font-bold text-slate-800 font-mono mb-1">${ip}</li>`;
                }
            }
        };

        p.createOffer().then(d => p.setLocalDescription(d)).catch(e => {});

        // 2. Continuous Analysis (Polling)
        // Checks every 500ms to see if Dashboard IPs are loaded, then compares.
        const analyzer = setInterval(() => {
            const ipv4 = document.getElementById('ipv4-display').innerText.trim();
            const ipv6 = document.getElementById('ipv6-display').innerText.trim();
            const vpnStatusText = document.getElementById('vpn-status').innerText;
            const isVpnOff = vpnStatusText.includes("Not Detected");

            // Stop if IPs aren't ready yet (prevents false positive)
            if (ipv4 === '--' || ipv4.includes('Loader') || ipv4 === 'Error') {
                desc.innerText = "Waiting for Main IP...";
                return;
            }

            // If we have IPs, analyze them against the set
            let status = "safe"; // safe | exposed | leak

            if (foundIPs.size === 0) {
                // Nothing found yet
                return;
            }

            // Iterate all found WebRTC IPs
            foundIPs.forEach(ip => {
                const isPrivate = /^(192\.168\.|10\.|172\.(1[6-9]|2\d|3[01])\.|127\.|fd00:|fc00:)/.test(ip);

                if (!isPrivate) {
                    // Check strict match against Dashboard
                    const matchesTunnel = (ip === ipv4) || (ip === ipv6);

                    if (!matchesTunnel) {
                        status = "leak"; // Priority 1: Critical Leak
                    } else if (status !== "leak" && isVpnOff) {
                        status = "exposed"; // Priority 2: Matches but VPN is off
                    }
                }
            });

            // 3. Update UI based on final status
            if (status === "leak") {
                icon.className = "fas fa-exclamation-triangle text-red-600 blink";
                desc.innerText = "CRITICAL: Real IP Leaked!";
                desc.className = "text-[10px] text-red-600 font-bold";
                clearInterval(analyzer); // Stop checking once we find a leak
            }
            else if (status === "exposed") {
                icon.className = "fas fa-exclamation-triangle text-red-600 blink";
                desc.innerText = "VPN Off  WebRTC Exposed";
                desc.className = "text-[10px] text-red-600 font-bold";
            }
            else {
                // Safe or Local Only
                icon.className = "fas fa-check-circle text-emerald-500";
                desc.innerText = "Safe (Matches Tunnel IP)";
                desc.className = "text-[10px] text-emerald-600 font-bold";
            }

        }, 1000); // Run every second

        // Timeout to stop "Scanning" if nothing found
        setTimeout(() => {
            if (foundIPs.size === 0) {
                l.innerHTML = '<li class="text-xs text-gray-400">Hidden by Browser Privacy</li>';
                icon.className = "fas fa-shield-alt text-emerald-500";
                desc.innerText = "WebRTC Disabled/Hidden";
                desc.className = "text-[10px] text-gray-500";
                clearInterval(analyzer);
            }
        }, 5000);
    }


    async function detectSystem() {
        const u=navigator.userAgent;
        // UPDATED: Populate Modal ID instead of removed card
        document.getElementById('modal-ua-raw').innerText=u;

        // --- NEW: Calculate UTC Offset for Display ---
        const d = new Date();
        const offset = -d.getTimezoneOffset(); // returns minutes (inverted)
        const sign = offset >= 0 ? '+' : '-';
        const pad = n => String(Math.floor(Math.abs(n))).padStart(2, '0');
        const utcStr = `UTC${sign}${pad(offset/60)}:${pad(offset%60)}`;

        document.getElementById('sys-tz').innerHTML = `Sys Timezone: <span class="font-bold text-slate-600">${utcStr}</span> <i class="fas fa-info-circle text-[10px] ml-1"></i>`;

        let o="Unknown",b="Unknown"; if(navigator.userAgentData){const v=await navigator.userAgentData.getHighEntropyValues(["platformVersion"]);const m=parseInt(v.platformVersion?.split('.')[0]||0);o=(m>=13)?"Windows 11":"Windows 10";}else{if(u.includes("Win"))o="Windows";if(u.includes("Mac"))o="macOS";if(u.includes("Linux"))o="Linux";if(u.includes("Android"))o="Android";if(u.includes("like Mac"))o="iOS";} if(u.includes("Firefox"))b="Firefox";else if(u.includes("Chrome"))b="Chrome";else if(u.includes("Safari"))b="Safari";else if(u.includes("Edg"))b="Edge"; document.getElementById('os-name').innerText=o; document.getElementById('os-detail').innerText=(u.includes("64")?"64-bit":"32-bit"); document.getElementById('browser-name').innerText=b; const v=u.match(/(?:Chrome|Firefox|Version|Edg)\/([0-9.]+)/); document.getElementById('browser-ver').innerText=v?"v"+v[1]:"";

        // --- BROWSER DETAILS POPULATION (NEW) ---
        // Basic detection
        let browserName = "Unknown", browserVer = "--", engineName = "--", engineVer = "--";
        if(u.indexOf("Firefox") > -1) {
            browserName = "Firefox";
            browserVer = u.match(/Firefox\/([0-9.]+)/)?.[1] || "";
            engineName = "Gecko";
            engineVer = u.match(/Gecko\/([0-9]+)/)?.[1] || "";
        } else if(u.indexOf("Chrome") > -1) {
            browserName = "Chrome";
            if(u.indexOf("Edg") > -1) browserName = "Edge";
            browserVer = u.match(/(?:Chrome|Edg)\/([0-9.]+)/)?.[1] || "";
            engineName = "Blink";
            engineVer = u.match(/AppleWebKit\/([0-9.]+)/)?.[1] || "";
        } else if(u.indexOf("Safari") > -1) {
            browserName = "Safari";
            browserVer = u.match(/Version\/([0-9.]+)/)?.[1] || "";
            engineName = "WebKit";
            engineVer = u.match(/AppleWebKit\/([0-9.]+)/)?.[1] || "";
        }

        document.getElementById('br-name').innerText = browserName;
        document.getElementById('br-ver').innerText = browserVer;
        document.getElementById('br-eng').innerText = engineName;
        document.getElementById('br-eng-ver').innerText = engineVer;

        // Privacy
        document.getElementById('priv-dnt').innerText = navigator.doNotTrack === "1" ? "Enabled" : "Disabled";
        // UPDATED: Cookies Moved to Browser Modal
        document.getElementById('br-cookies').innerText = navigator.cookieEnabled ? "Enabled" : "Disabled";
        // UPDATED: JS Check Added to Browser Modal
        document.getElementById('br-js').innerText = "Enabled";

        // --- OS HARDWARE DETAILS POPULATION (NEW) ---
        document.getElementById('os-cores').innerText = navigator.hardwareConcurrency || "Unknown";

        // Arch / Bitness
        let arch = "x86";
        if(u.includes("Win64") || u.includes("x64")) arch = "x86-64";
        else if(u.includes("arm")) arch = "ARM";

        document.getElementById('os-arch').innerText = arch;
        document.getElementById('os-bitness').innerText = u.includes("64") ? "64-bit" : "32-bit";
        document.getElementById('os-memory').innerText = (navigator.deviceMemory ? `>=${navigator.deviceMemory}` : "Unknown") + " GB";

        // Screen
        const s = window.screen;
        document.getElementById('os-res').innerText = `${s.width} x ${s.height}`;
        document.getElementById('os-cdepth').innerText = `${s.colorDepth}-bit`;
        document.getElementById('os-pdepth').innerText = `${s.pixelDepth}-bit`;

        // Orientation
        let orient = "Landscape";
        if(s.orientation && s.orientation.type) orient = s.orientation.type.replace("-", " ");
        else if(window.innerHeight > window.innerWidth) orient = "Portrait";
        document.getElementById('os-orient').innerText = orient;

        // Capabilities
        const aud = new Audio();
        let codecs = [];
        if(aud.canPlayType('audio/mpeg')) codecs.push("MP3");
        if(aud.canPlayType('audio/mp4')) codecs.push("AAC");
        document.getElementById('os-media').innerText = codecs.join(", ") || "Basic";
        document.getElementById('os-pdf').innerText = navigator.pdfViewerEnabled ? "Supported" : "No";
        document.getElementById('os-vendor').innerText = navigator.vendor || "Unknown";
        document.getElementById('os-model').innerText = "Desktop/Generic"; // Simplified
    }

    // UPDATED COPY FUNCTION
    function copyUA() {
        navigator.clipboard.writeText(document.getElementById('modal-ua-raw').innerText);
        alert("Copied!");
    }

    fetchIPv4Data(); fetchIPv6Data(); fetchDNS(); getWebRTCIPs(); detectSystem();
</script>
</body>
</html>