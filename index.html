<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
            color: #334155;
        }
        .card {
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.75rem;
            z-index: 1;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }

        /* --- GAUGE STYLES --- */
        svg.gauge-svg { overflow: visible; }
        .gauge-bg { stroke: #cbd5e1; fill: #f1f5f9; opacity: 0.5; }
        .gauge-fill {
            stroke: #10b981;
            stroke-linecap: round;
            transition: stroke-dasharray 0.6s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.3s ease;
        }
        .no-anim-trans { transition: none !important; }
        .gauge-pulse { animation: gaugeGlow 1.5s ease-in-out infinite alternate; }
        @keyframes gaugeGlow {
            from { filter: drop-shadow(0 0 2px rgba(16, 185, 129, 0.4)); stroke-width: 2.5; }
            to { filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.8)); stroke-width: 2.8; }
        }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 relative">

<div id="cookie-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[5000] hidden opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md mx-4 transform scale-95 transition-transform duration-300" id="cookie-content">
        <div class="text-center mb-4">
            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                <i class="fas fa-cookie-bite text-xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Terms of Service & History</h3>
            <p class="text-sm text-gray-500 mt-2">
                To use this dashboard, you must acknowledge and agree to the
                <button onclick="openPrivacy()" class="text-blue-600 hover:underline font-bold">Privacy Policy</button>
                and the <strong>End User License Agreements (EULA)</strong> of our third-party data providers. We also utilize cookies to store your speed test history locally.
                <br><br>
                <strong>Please select your preference to accept these terms:</strong>
            </p>
        </div>
        <div class="flex flex-col space-y-3 mt-6">
            <button onclick="handleConsent(true)" class="w-full py-3 px-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition shadow-lg shadow-emerald-200 text-sm">
                Agree to Terms & Enable History
            </button>
            <button onclick="handleConsent(false)" class="w-full py-3 px-4 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg font-medium transition text-xs border border-gray-200">
                Agree to Terms & Use Necessary Cookies Only
            </button>
        </div>
    </div>
</div>

<div id="privacy-modal" class="fixed inset-0 z-[6000] hidden transition-opacity duration-300 opacity-0 bg-white/95 backdrop-blur-sm">
    <div id="privacy-content" class="w-full h-full overflow-y-auto transform transition-transform duration-300 scale-95">
        <div class="max-w-4xl mx-auto p-8 md:p-12 bg-white min-h-screen shadow-2xl border-x border-gray-100">
            <div class="flex justify-between items-center mb-8 border-b pb-4 sticky top-0 bg-white/95 backdrop-blur z-10 pt-2">
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Privacy Policy & Terms</h1>
                <button onclick="closePrivacy()" class="text-slate-500 hover:text-slate-800 transition text-sm font-bold px-4 py-2 hover:bg-slate-100 rounded-lg flex items-center gap-2">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>

            <div class="prose prose-slate max-w-none text-slate-700 pb-12">
                <p class="text-sm text-gray-400 mb-6 font-mono">Last Updated: <span id="policy-date"></span></p>

                <div class="bg-amber-50 border-l-4 border-amber-500 p-4 mb-8 rounded-r-lg">
                    <p class="font-bold text-amber-900 m-0"><i class="fas fa-gavel mr-2"></i>Automatic Acceptance of Terms</p>
                    <p class="text-amber-800 text-sm mt-2 m-0 leading-relaxed">
                        By accessing, browsing, or using this website, you <strong>automatically acknowledge and agree</strong> to be bound by:
                    </p>
                    <ul class="list-disc pl-5 mt-2 text-amber-900 text-xs font-bold space-y-1">
                        <li>The Privacy Policy of this Dashboard.</li>
                        <li>The Privacy Policies of all Third-Party APIs listed below.</li>
                        <li>The End User License Agreements (EULA) of all Third-Party APIs listed below.</li>
                    </ul>
                    <p class="text-amber-800 text-xs mt-2 m-0">
                        If you do not agree to these terms, you must close this website immediately.
                    </p>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8 rounded-r-lg">
                    <p class="font-bold text-blue-900 m-0">The Core Promise: Zero Backend Storage</p>
                    <p class="text-blue-800 text-sm mt-1 m-0">
                        This Network Dashboard operates entirely as a <strong>Client-Side Application</strong>. We do not own, operate, or rent servers to store your personal data. Your IP address, speed test results, and location data <strong>never</strong> leave your browser to reach us.
                    </p>
                </div>

                <h3 class="text-xl font-bold text-slate-900 mt-8 mb-4">1. How This Application Works</h3>
                <p>
                    Unlike traditional web services, this dashboard runs locally in your web browser using JavaScript. When you open this page, your browser executes code to analyze your network connection in real-time. The Speed Test uses extended durations (up to 15 seconds for download, 12 seconds for upload) to ensure a more accurate, stable average of your network performance.
                </p>
                <ul class="list-disc pl-5 space-y-2 mb-4">
                    <li><strong>No User Accounts:</strong> We do not require login, email, or registration.</li>
                    <li><strong>No Tracking Analytics:</strong> We do not use Google Analytics, Facebook Pixels, or third-party behavior trackers.</li>
                    <li><strong>Voluntary Execution:</strong> Network tests (like Speed Tests) only run when you explicitly initiate them.</li>
                </ul>

                <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg text-sm">
                    <strong><i class="fab fa-github mr-1"></i> Open Source Transparency:</strong>
                    To verify our security and privacy claims, the full source code of this dashboard is publicly available for inspection on GitHub:
                    <a href="https://github.com/kkkkja-co/Network-Checking-Dashboard" target="_blank" class="block mt-1 text-blue-600 hover:underline font-mono break-all">
                        https://github.com/kkkkja-co/Network-Checking-Dashboard
                    </a>
                </div>

                <h3 class="text-xl font-bold text-slate-900 mt-8 mb-4">2. Third-Party Data Processors & EULAs</h3>
                <p>
                    To provide functionality, this application instructs your browser to connect directly to the following public APIs. <strong>By using this dashboard, you agree to the Terms of Service and EULAs of these providers:</strong>
                </p>
                <div class="overflow-x-auto mt-4 mb-8 border rounded-lg">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-600 font-bold uppercase">
                        <tr>
                            <th class="px-4 py-3">Provider</th>
                            <th class="px-4 py-3">Role</th>
                            <th class="px-4 py-3">Agreement</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                        <tr>
                            <td class="px-4 py-3 font-semibold">Cloudflare</td>
                            <td class="px-4 py-3">Speed Engine & Trace</td>
                            <td class="px-4 py-3 text-xs">Subject to Cloudflare Privacy & Terms</td>
                        </tr>
                        <tr>
                            <td class="px-4 py-3 font-semibold">ipwho.is</td>
                            <td class="px-4 py-3">Geolocation & ISP</td>
                            <td class="px-4 py-3 text-xs">Subject to ipwho.is Terms of Use</td>
                        </tr>
                        <tr>
                            <td class="px-4 py-3 font-semibold">ipify / ip-api</td>
                            <td class="px-4 py-3">Connectivity Checks</td>
                            <td class="px-4 py-3 text-xs">Subject to provider EULAs</td>
                        </tr>
                        <tr>
                            <td class="px-4 py-3 font-semibold">OpenStreetMap</td>
                            <td class="px-4 py-3">Map Visualization</td>
                            <td class="px-4 py-3 text-xs">ODbL License Agreement</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-bold text-slate-900 mt-8 mb-4">3. Local Storage & Cookies</h3>
                <p>We use browser storage technologies solely to improve your user experience. This data resides on your device and can be cleared at any time.</p>
                <ul class="list-disc pl-5 space-y-2 text-sm">
                    <li><strong>speedtest_history:</strong> Stores your past 50 test results locally.</li>
                    <li><strong>speedtest_consent:</strong> Remembers your acceptance of these terms.</li>
                </ul>

                <h3 class="text-xl font-bold text-slate-900 mt-8 mb-4">4. Feature-Specific Disclosures</h3>

                <h4 class="font-bold text-slate-800 mt-4">A. WebRTC Leak Detection</h4>
                <p class="text-sm">
                    This tool uses STUN servers to detect local IP leaks. This process is done client-side. We do not log detected IPs.
                </p>

                <h4 class="font-bold text-slate-800 mt-4">B. VPN Detection & Reporting</h4>
                <p class="text-sm">
                    The VPN detection uses heuristics (ISP name, ASN, timezone/language consistency) run locally to assess risk. If you use the **"Report Mis-detection"** button, this action initiates a local `mailto:` link which includes your IP, ISP details, and the detected status in the email body. This information is **not** sent to our backend servers; it is prepared locally for you to send manually to the developer for debugging purposes. **Any report data received by the developer will be deleted within 3 days.**
                </p>

                <h3 class="text-xl font-bold text-slate-900 mt-8 mb-4">5. Disclaimer</h3>
                <p>
                    This software is provided "as is" without warranty of any kind. Speed test results are estimates. By using this tool, you release the developer from any liability regarding data usage or third-party connections.
                </p>

                <hr class="my-8 border-gray-200">
                <p class="text-xs text-gray-500 text-center">
                    End of Privacy Policy.
                </p>
            </div>
        </div>
    </div>
</div>

<div id="tz-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[7000] hidden opacity-0 transition-opacity duration-300" onclick="closeTz()">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300 relative max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
        <button onclick="closeTz()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-lg"></i></button>
        <div class="mb-5 flex-shrink-0">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="far fa-clock text-blue-500"></i> Timezone Check</h3>
            <p class="text-xs text-gray-500 mt-1">Detailed system time configuration</p>
        </div>
        <div class="space-y-4 overflow-y-auto custom-scroll pr-1">
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                <p class="text-[10px] text-blue-500 uppercase font-bold tracking-wider mb-1">UTC Offset</p>
                <p id="modal-utc" class="font-mono text-2xl font-bold text-blue-700 tracking-tight">--</p>
            </div>
            <div class="grid grid-cols-1 gap-3">
                <div class="border-b border-gray-100 pb-2">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-0.5">IANA Region Code</p>
                    <p id="modal-region" class="font-mono text-sm font-semibold text-slate-700">--</p>
                </div>
                <div class="border-b border-gray-100 pb-2">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-0.5">Local System Time</p>
                    <p id="modal-local" class="font-mono text-xs text-slate-600 break-words leading-tight">--</p>
                </div>
                <div class="border-b border-gray-100 pb-2">
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-0.5">UTC Time</p>
                    <p id="modal-global" class="font-mono text-xs text-slate-600 break-words leading-tight">--</p>
                </div>
                <div>
                    <p id="modal-regions-title" class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">Regions with same UTC Offset</p>
                    <div class="bg-gray-50 rounded border border-gray-200 p-2 h-32 overflow-y-auto custom-scroll">
                        <ul id="modal-all-regions" class="text-[10px] font-mono text-slate-600 space-y-1"><li>Loading...</li></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="os-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[7000] hidden opacity-0 transition-opacity duration-300" onclick="closeOsModal()">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4 transform scale-95 transition-transform duration-300 relative max-h-[90vh] overflow-y-auto custom-scroll" onclick="event.stopPropagation()">
        <button onclick="closeOsModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-lg"></i></button>
        <div class="mb-5">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-microchip text-teal-500"></i> System & Hardware</h3>
            <p class="text-xs text-gray-500 mt-1">Detailed Operating System & Device Info</p>
        </div>
        <div class="space-y-4">
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">CPU & Architecture</h4>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div><span class="text-gray-400 block">Cores (Logical)</span><span class="font-mono font-bold text-slate-700" id="os-cores">--</span></div>
                    <div><span class="text-gray-400 block">Architecture</span><span class="font-mono font-bold text-slate-700" id="os-arch">--</span></div>
                    <div><span class="text-gray-400 block">Bitness</span><span class="font-mono font-bold text-slate-700" id="os-bitness">--</span></div>
                    <div><span class="text-gray-400 block">Memory (RAM)</span><span class="font-mono font-bold text-slate-700" id="os-memory">--</span></div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Device Identity</h4>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div><span class="text-gray-400 block">Vendor</span><span class="font-mono font-bold text-slate-700" id="os-vendor">--</span></div>
                    <div><span class="text-gray-400 block">Model</span><span class="font-mono font-bold text-slate-700" id="os-model">--</span></div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Display & Graphics</h4>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div><span class="text-gray-400 block">Resolution</span><span class="font-mono font-bold text-slate-700" id="os-res">--</span></div>
                    <div><span class="text-gray-400 block">Color Depth</span><span class="font-mono font-bold text-slate-700" id="os-cdepth">--</span></div>
                    <div><span class="text-gray-400 block">Pixel Depth</span><span class="font-mono font-bold text-slate-700" id="os-pdepth">--</span></div>
                    <div><span class="text-gray-400 block">Orientation</span><span class="font-mono font-bold text-slate-700" id="os-orient">--</span></div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Capabilities</h4>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between border-b border-slate-100 pb-1">
                        <span class="text-gray-500">PDF Viewer</span>
                        <span class="font-bold text-slate-700" id="os-pdf">--</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-1 pt-1">
                        <span class="text-gray-500">Media Codecs</span>
                        <span class="font-bold text-slate-700" id="os-media">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="browser-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[7000] hidden opacity-0 transition-opacity duration-300" onclick="closeBrowserModal()">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4 transform scale-95 transition-transform duration-300 relative" onclick="event.stopPropagation()">
        <button onclick="closeBrowserModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-lg"></i></button>
        <div class="mb-5">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fab fa-chrome text-orange-500"></i> Browser Information</h3>
            <p class="text-xs text-gray-500 mt-1">Detailed Browser Identity</p>
        </div>
        <div class="space-y-4">
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 font-mono text-xs text-slate-600 break-all leading-relaxed" id="modal-ua-raw">Loading...</div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Browser Identity</h4>
                <div class="grid grid-cols-2 gap-y-2 text-xs">
                    <div><span class="text-gray-400 block">Name</span><span class="font-bold text-slate-700" id="br-name">--</span></div>
                    <div><span class="text-gray-400 block">Version</span><span class="font-bold text-slate-700" id="br-ver">--</span></div>
                    <div><span class="text-gray-400 block">Engine</span><span class="font-bold text-slate-700" id="br-eng">--</span></div>
                    <div><span class="text-gray-400 block">Eng. Ver</span><span class="font-bold text-slate-700" id="br-eng-ver">--</span></div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Settings & Permissions</h4>
                <div class="grid grid-cols-2 gap-y-2 text-xs">
                    <div><span class="text-gray-400 block">Cookies</span><span class="font-bold text-slate-700" id="br-cookies">--</span></div>
                    <div><span class="text-gray-400 block">JavaScript</span><span class="font-bold text-slate-700" id="br-js">--</span></div>
                </div>
            </div>
        </div>
        <div class="mt-4 flex justify-end">
            <button onclick="copyUA()" class="text-xs bg-slate-800 text-white hover:bg-slate-700 px-4 py-2 rounded transition shadow flex items-center"><i class="far fa-copy mr-2"></i> Copy User Agent</button>
        </div>
    </div>
</div>

<div id="vpn-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[7000] hidden opacity-0 transition-opacity duration-300" onclick="closeVpnModal()">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300 relative max-h-[90vh] overflow-y-auto flex flex-col" onclick="event.stopPropagation()">
        <button onclick="closeVpnModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-lg"></i></button>
        <div class="mb-5 flex-shrink-0">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-shield-alt text-cyan-500"></i> VPN & Privacy Report</h3>
            <p class="text-xs text-gray-500 mt-1">Detailed Analysis of your connection privacy</p>
        </div>
        <div class="space-y-4 flex-grow overflow-y-auto custom-scroll pr-1">

            <div class="bg-gray-100 p-3 rounded-lg border border-gray-200">
                <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Raw Detection String (ISP + Org + ASN)</h4>
                <div class="font-mono text-[10px] text-slate-700 break-all leading-relaxed" id="vpn-raw-string">--</div>
            </div>

            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 flex justify-between items-center">
                <span class="text-sm font-bold text-slate-600">Privacy Level</span>
                <span id="vpn-risk-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-gray-200 text-gray-600">Calculating...</span>
            </div>

            <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 h-auto min-h-[80px]">
                <h4 class="text-xs font-bold text-purple-500 uppercase mb-2">Provider & Risk Analysis</h4>

                <div class="grid grid-cols-2 gap-4 text-xs items-start">
                    <div class="flex flex-col">
                        <span class="text-gray-400 mb-0.5">Detected Provider</span>
                        <span class="font-bold text-slate-700 break-words whitespace-normal leading-snug" id="vpn-provider-name">--</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-gray-400 mb-0.5">IP Fraud Risk</span>
                        <span class="font-bold text-slate-700 break-words" id="vpn-fraud-score">--</span>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                <h4 class="text-xs font-bold text-blue-500 uppercase mb-2">Tracking Protection</h4>
                <div class="grid grid-cols-2 gap-y-2 text-xs">
                    <div>
                        <span class="text-gray-400 block">Do Not Track</span>
                        <span class="font-bold text-slate-700" id="priv-dnt">--</span>
                    </div>
                </div>
            </div>

            <div class="border-b border-gray-100 pb-3">
                <div class="flex justify-between items-center mb-1"><p class="text-xs font-bold text-slate-700">1. ISP / ASN Check</p><i id="icon-isp" class="fas fa-circle text-[10px] text-gray-300"></i></div>
                <p class="text-[10px] text-gray-500" id="desc-isp">Analyzing provider name...</p>
            </div>
            <div class="border-b border-gray-100 pb-3">
                <div class="flex justify-between items-center mb-1"><p class="text-xs font-bold text-slate-700">2. Timezone Consistency</p><i id="icon-tz" class="fas fa-circle text-[10px] text-gray-300"></i></div>
                <p class="text-[10px] text-gray-500" id="desc-tz">Comparing System vs IP Time...</p>
            </div>
            <div class="border-b border-gray-100 pb-3">
                <div class="flex justify-between items-center mb-1"><p class="text-xs font-bold text-slate-700">3. Language / Locale</p><i id="icon-lang" class="fas fa-circle text-[10px] text-gray-300"></i></div>
                <p class="text-[10px] text-gray-500" id="desc-lang">Checking browser language vs IP country...</p>
            </div>
            <div class="border-b border-gray-100 pb-3">
                <div class="flex justify-between items-center mb-1"><p class="text-xs font-bold text-slate-700">4. WebRTC Leak</p><i id="icon-webrtc" class="fas fa-circle text-[10px] text-gray-300"></i></div>
                <p class="text-[10px] text-gray-500" id="desc-webrtc">Checking for leaked IPs...</p>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1"><p class="text-xs font-bold text-slate-700">5. Tor / Onion Routing</p><i id="icon-tor" class="fas fa-circle text-[10px] text-gray-300"></i></div>
                <p class="text-[10px] text-gray-500" id="desc-tor">Checking for Tor exit nodes...</p>
            </div>
        </div>

        <div class="mt-4 pt-4 border-t border-gray-100 flex-shrink-0">
            <button onclick="reportMisdetection()" class="w-full py-2 bg-slate-800 text-white rounded-lg shadow hover:bg-slate-700 transition flex items-center justify-center text-sm font-semibold">
                <i class="fas fa-bug mr-2"></i> Report Mis-detection / False Positive
            </button>
        </div>

    </div>
</div>

<div id="speed-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[7000] hidden opacity-0 transition-opacity duration-300" onclick="closeSpeedModal()">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300 relative max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <button onclick="closeSpeedModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-lg"></i></button>
        <div class="mb-5">
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i class="fas fa-tachometer-alt text-emerald-500"></i> Speed Analysis
            </h3>
            <p class="text-xs text-gray-500 mt-1">Detailed Network Performance Metrics</p>
        </div>

        <div class="space-y-4">
            <div class="flex items-center justify-between bg-slate-50 p-4 rounded-lg border border-slate-200">
                <div>
                    <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider">Network Grade</p>
                    <p class="text-xs text-gray-400 mt-1">Based on Speed/Latency</p>
                </div>
                <div id="net-grade" class="text-3xl font-black text-slate-300">--</div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                    <p class="text-[10px] font-bold text-blue-500 uppercase mb-1">Download</p>
                    <p id="modal-dl" class="text-lg font-bold text-slate-800">--</p>
                </div>
                <div class="p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                    <p class="text-[10px] font-bold text-purple-500 uppercase mb-1">Upload</p>
                    <p id="modal-ul" class="text-lg font-bold text-slate-800">--</p>
                </div>
                <div class="p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                    <p class="text-[10px] font-bold text-orange-500 uppercase mb-1">Latency (Ping)</p>
                    <p id="modal-ping" class="text-lg font-bold text-slate-800">--</p>
                </div>
                <div class="p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                    <p class="text-[10px] font-bold text-teal-500 uppercase mb-1">Jitter</p>
                    <p id="modal-jitter" class="text-lg font-bold text-slate-800">--</p>
                </div>
            </div>

            <div class="bg-red-50 p-3 rounded-lg border border-red-100 flex justify-between items-center">
                <div>
                    <p class="text-xs font-bold text-red-500 uppercase">Packet Loss</p>
                    <p class="text-[10px] text-red-400">Estimated TCP Success Rate</p>
                </div>
                <p id="modal-ploss" class="text-lg font-bold text-red-600">--</p>
            </div>

            <div class="border-t border-gray-100 pt-3">
                <p class="text-xs font-bold text-slate-500 mb-2 uppercase">Streaming Capability</p>
                <div class="flex gap-2">
                    <span id="badge-4k" class="opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold">4K HDR</span>
                    <span id="badge-1080p" class="opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold">1080p HD</span>
                    <span id="badge-720p" class="opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold">720p</span>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="max-w-7xl mx-auto">

    <header class="mb-4 flex flex-col md:flex-row justify-between items-end md:items-center border-b border-gray-200 pb-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Network Dashboard</h1>
            <div class="flex items-center mt-1 space-x-3 text-xs text-gray-500 font-mono">
                <span id="last-update">--</span>
            </div>
        </div>
        <div class="flex gap-2 mt-3 md:mt-0 items-center">
            <a href="https://github.com/kkkkja-co/Network-Checking-Dashboard" target="_blank" class="px-3 py-1.5 bg-slate-800 text-white rounded text-sm shadow hover:bg-slate-900 transition flex items-center font-semibold">
                <i class="fab fa-github text-sm md:mr-2"></i> <span class="hidden md:inline">GitHub</span>
            </a>

            <button onclick="window.location.reload()" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-700 rounded text-sm shadow-sm hover:bg-gray-50 transition flex items-center">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </header>

    <div class="flex justify-center mb-6">
        <span class="text-xs font-medium text-slate-400 bg-slate-100 px-3 py-1 rounded-full flex items-center shadow-sm">
            <i class="fas fa-arrow-down mr-2 animate-bounce text-slate-500"></i> Scroll down for more
        </span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-blue-500 relative">
            <div class="flex justify-between items-start">
                <div class="w-full">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Public IPv4</p>
                    <h2 class="text-xl font-bold text-slate-800 mt-1 font-mono" id="ipv4-display"><span class="loader"></span></h2>
                    <p class="text-xs text-gray-500 mt-1" id="ipv4-loc">Locating...</p>
                    <p class="text-xs text-gray-400 font-mono mt-0.5 mb-2 cursor-pointer hover:text-blue-600 transition decoration-dotted underline underline-offset-4"
                       id="sys-tz" onclick="showTzModal()" title="Click for extra info">
                        Sys Timezone: <span class="loader w-3 h-3 border-2"></span>
                    </p>
                </div>
                <div class="p-2 bg-blue-50 rounded-lg text-blue-600 ml-2 absolute top-5 right-5"><i class="fas fa-globe"></i></div>
            </div>
            <div class="pt-3 border-t border-gray-100 mt-2">
                <div class="flex flex-row">
                    <div class="flex-1 pr-3 border-r border-gray-200">
                        <div class="mb-3">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">ISP</p>
                            <p class="text-xs font-bold text-slate-700 leading-tight break-words" id="isp-display">--</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Organization</p>
                            <p class="text-xs font-medium text-slate-600 leading-tight break-words" id="org-display">--</p>
                        </div>
                    </div>
                    <div class="flex-1 pl-3">
                        <div class="mb-3">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">AS Organization</p>
                            <p class="text-xs font-bold text-slate-700 leading-tight break-words" id="as-org-display">--</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">AS Number</p>
                            <p class="text-xs font-mono font-medium text-slate-600 leading-tight" id="asn-display">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-purple-500 relative">
            <div class="flex justify-between items-start">
                <div class="w-full overflow-hidden">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Public IPv6</p>
                    <h2 class="text-xl font-bold text-slate-800 mt-1 font-mono break-all leading-tight" id="ipv6-display"><span class="loader"></span></h2>
                    <p class="text-xs text-gray-500 mt-1 mb-2" id="ipv6-status">Checking...</p>
                </div>
                <div class="p-2 bg-purple-50 rounded-lg text-purple-600 ml-2 absolute top-5 right-5"><i class="fas fa-project-diagram"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Provider (v6)</p>
                <p class="text-sm font-bold text-slate-700 leading-tight" id="ipv6-provider">--</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-red-500 relative">
            <div class="flex justify-between items-start mb-2">
                <div class="w-full">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">WebRTC / LAN IP</p>
                    <ul id="webrtc-list" class="mt-2 space-y-1">
                        <li class="flex items-center text-sm"><span class="loader mr-2"></span> Scanning...</li>
                    </ul>
                </div>
                <div class="p-2 bg-red-50 rounded-lg text-red-600 ml-2 absolute top-5 right-5"><i class="fas fa-network-wired"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs text-gray-400">Local Network Leaks</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-pink-500 relative h-full flex flex-col justify-between">
            <div class="flex justify-between items-start mb-2 shrink-0">
                <div class="w-full">
                    <div class="flex items-center justify-between pr-10">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">DNS Servers</p>
                        <span id="dns-count-badge" class="hidden text-[10px] bg-pink-100 text-pink-700 px-2 py-0.5 rounded-full font-bold uppercase tracking-wide">0 Found</span>
                    </div>
                </div>
                <div class="p-2 bg-pink-50 rounded-lg text-pink-600 ml-2 absolute top-5 right-5"><i class="fas fa-server"></i></div>
            </div>
            <div class="h-40 overflow-y-auto custom-scroll relative mt-2 w-full">
                <ul id="dns-list" class="space-y-2 h-full break-all">
                    <li class="text-sm text-gray-600 flex items-center h-full"><span class="loader mr-2"></span> Probing...</li>
                </ul>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto shrink-0">
                <p class="text-xs text-gray-400">Detected Resolvers</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-indigo-500 relative min-h-[11rem]">
            <div class="flex justify-between items-start">
                <div class="w-full">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Hostname</p>
                    <h2 class="text-lg font-bold text-slate-800 mt-1 font-mono break-all leading-snug" id="hostname-display"><span class="loader"></span></h2>
                </div>
                <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600 ml-2 absolute top-5 right-5"><i class="fas fa-tag"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs text-gray-400">Reverse DNS / PTR</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-teal-500 relative min-h-[11rem]">
            <div class="flex justify-between items-start">
                <div class="w-full">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Operating System</p>
                    <h2 class="text-lg font-bold text-slate-800 mt-1" id="os-name">--</h2>
                    <p class="text-xs text-gray-500" id="os-detail">--</p>
                    <button onclick="showOsModal()" class="text-xs text-gray-400 font-mono hover:text-blue-600 transition flex items-center mt-1">
                        <span class="decoration-dotted underline underline-offset-4">More Info</span> <i class="fas fa-info-circle ml-1"></i>
                    </button>
                </div>
                <div class="p-2 bg-teal-50 rounded-lg text-teal-600 ml-2 absolute top-5 right-5"><i class="fas fa-microchip"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs text-gray-400">Platform Details</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-orange-500 relative">
            <div class="flex justify-between items-start">
                <div class="w-full">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Browser</p>
                    <h2 class="text-lg font-bold text-slate-800 mt-1" id="browser-name">--</h2>
                    <p class="text-xs text-gray-500 mb-1" id="browser-ver">--</p>
                    <button onclick="showBrowserModal()" class="text-xs text-gray-400 font-mono hover:text-blue-600 transition flex items-center">
                        <span class="decoration-dotted underline underline-offset-4">More Info</span> <i class="fas fa-info-circle ml-1"></i>
                    </button>
                </div>
                <div class="p-2 bg-orange-50 rounded-lg text-orange-600 ml-2 absolute top-5 right-5"><i class="fab fa-chrome"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs text-gray-400">Browser Details</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-5 border-t-4 border-cyan-500 relative">
            <div class="flex justify-between items-start">
                <div class="w-full">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">VPN / Privacy Check</p>
                            <h2 class="text-lg font-bold mt-1" id="vpn-status"><span class="loader"></span></h2>
                        </div>
                    </div>
                    <button onclick="showVpnModal()" class="text-xs text-gray-400 font-mono hover:text-blue-600 transition flex items-center mt-1 mb-2">
                        <span class="decoration-dotted underline underline-offset-4">More Info</span> <i class="fas fa-info-circle ml-1"></i>
                    </button>
                    <div id="vpn-details" class="text-xs text-gray-500 leading-tight">Analyzing...</div>
                </div>
                <div class="p-2 bg-cyan-50 rounded-lg text-cyan-600 ml-2 absolute top-5 right-5"><i class="fas fa-user-secret"></i></div>
            </div>
            <div class="pt-2 border-t border-gray-100 mt-auto">
                <p class="text-xs text-gray-400">Proxy & ISP Analysis</p>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-1 border border-gray-100 md:col-span-2 md:row-span-2 h-full min-h-[24rem] relative z-0">
            <div id="map"></div>
            <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-2 rounded shadow text-xs z-[999] border border-gray-200">
                <strong>Coordinates</strong><br>
                <span id="map-coords" class="text-gray-500 font-mono">--</span>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-6 border-t-4 border-emerald-500 md:col-span-2 md:row-span-2">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Speed Test (Multi-Stream)</h3>
                    <p class="text-xs text-gray-400 mt-1 mb-1">4 Concurrent Connections</p>
                    <button onclick="showSpeedModal()" class="text-xs text-gray-400 font-mono hover:text-blue-600 transition flex items-center">
                        <span class="decoration-dotted underline underline-offset-4">More Info</span> <i class="fas fa-info-circle ml-1"></i>
                    </button>
                </div>
                <div id="speed-status-icon" class="p-2 bg-gray-50 rounded-lg text-gray-400"><i class="fas fa-wifi"></i></div>
            </div>

            <div class="mb-6 bg-slate-50 p-2 rounded-lg border border-slate-100 flex justify-between items-center text-xs">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-server text-gray-400"></i>
                    <span class="text-gray-500 font-medium">Server:</span>
                    <span id="server-location" class="font-bold text-slate-700">Detecting...</span>
                    <button onclick="refreshServerLocation()" title="Refresh/Relocate Server" class="ml-1 text-slate-400 hover:text-blue-600 transition p-1 rounded-full hover:bg-white">
                        <i class="fas fa-sync-alt" id="server-refresh-icon"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500 font-medium hidden sm:inline">Provider:</span>
                    <span class="font-bold text-slate-700">Cloudflare</span>
                </div>
            </div>

            <div class="flex flex-col md:flex-row items-center md:space-x-8 space-y-6 md:space-y-0 h-full justify-center pb-2">
                <div class="relative w-44 h-44 flex-shrink-0" id="gauge-container">
                    <svg class="w-full h-full transform -rotate-90 gauge-svg" viewBox="0 0 36 36">
                        <path class="gauge-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="2.5" />
                        <path id="speed-gauge" class="gauge-fill" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="2.5" stroke-dasharray="0, 100" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span class="text-4xl font-bold text-slate-800" id="gauge-value">0</span>
                        <span class="text-xs text-gray-400 uppercase mt-1 font-semibold" id="gauge-label">Start</span>
                    </div>
                </div>

                <div class="flex-1 w-full space-y-4">
                    <div class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded">
                        <span class="text-xs text-gray-500 font-semibold uppercase">Status</span>
                        <span class="text-xs font-bold text-emerald-600" id="test-state">Idle</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                        <span class="text-sm text-gray-500"><i class="fas fa-exchange-alt text-xs mr-2"></i>Latency</span>
                        <span class="font-mono font-bold text-slate-700" id="ping-value">-- ms</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                        <span class="text-sm text-gray-500"><i class="fas fa-arrow-down text-xs mr-2 text-blue-500"></i>Download</span>
                        <span class="font-mono font-bold text-blue-600" id="dl-final">-- Mbps</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                        <span class="text-sm text-gray-500"><i class="fas fa-arrow-up text-xs mr-2 text-purple-500"></i>Upload</span>
                        <span class="font-mono font-bold text-purple-600" id="ul-final">-- Mbps</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden mt-2">
                        <div class="bg-emerald-500 h-1.5 rounded-full transition-all duration-200" id="speed-progress" style="width: 0%"></div>
                    </div>

                    <div class="mt-4 flex space-x-2">
                        <button id="btn-card-speed" onclick="runHighPerformanceTest()" class="w-full px-4 py-2 bg-emerald-600 text-white rounded-lg shadow hover:bg-emerald-700 transition flex items-center justify-center font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-play mr-2"></i> Start Speedtest
                        </button>
                        <button id="btn-stop-speed" onclick="stopSpeedTest()" class="hidden w-full px-4 py-2 bg-red-50 text-red-600 rounded-lg shadow-sm border border-red-100 hover:bg-red-100 transition flex items-center justify-center font-bold">
                            <i class="fas fa-stop mr-2"></i> Stop
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-white rounded-xl shadow-sm p-6 border-t-4 border-gray-500 md:col-span-4">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wider">Previous Tests</h3>
                    <p class="text-xs text-gray-400 mt-1">Saved locally via Cookies</p>
                </div>
                <div class="flex space-x-2 text-xs items-center">
                    <div class="relative group mr-2">
                        <select id="history-limit-select" onchange="updateHistoryLimit()" class="bg-gray-50 border border-gray-200 text-gray-600 text-[10px] font-semibold uppercase tracking-wide rounded px-2 py-1.5 focus:outline-none focus:border-blue-300 cursor-pointer">
                            <option value="5">Keep 5</option>
                            <option value="10">Keep 10</option>
                            <option value="25">Keep 25</option>
                            <option value="50" selected>All (Max 50)</option>
                        </select>
                    </div>

                    <span id="consent-status" class="px-2 py-1.5 rounded bg-gray-100 text-gray-500 font-semibold">Checking...</span>
                    <button id="btn-enable-history" onclick="showConsentModal()" class="hidden px-3 py-1.5 bg-blue-50 text-blue-600 rounded border border-blue-200 hover:bg-blue-100 font-semibold transition"><i class="fas fa-check-circle mr-1"></i> Enable</button>
                    <button id="btn-disable-history" onclick="disableHistory()" class="hidden px-3 py-1.5 bg-gray-100 text-gray-600 rounded border border-gray-300 hover:bg-gray-200 font-semibold transition"><i class="fas fa-ban mr-1"></i> Disable</button>
                    <button id="btn-clear-history" onclick="clearHistory()" class="hidden text-red-500 hover:text-red-700 hover:underline px-2"><i class="fas fa-trash-alt mr-1"></i> Clear</button>
                </div>
            </div>
            <div class="overflow-x-auto overflow-y-auto max-h-80 custom-scroll border border-gray-50 rounded-lg">
                <table class="min-w-full text-sm text-left relative">
                    <thead class="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="px-4 py-2">Time</th>
                        <th class="px-4 py-2">IP Address</th>
                        <th class="px-4 py-2">ISP</th>
                        <th class="px-4 py-2">Server</th>
                        <th class="px-4 py-2">Latency</th>
                        <th class="px-4 py-2">Download</th>
                        <th class="px-4 py-2">Upload</th>
                    </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-gray-100 text-slate-700 bg-white"></tbody>
                </table>
            </div>
        </div>

    </div>

    <footer class="mt-12 mb-6 text-center border-t border-gray-200 pt-6">
        <p class="text-sm text-gray-400 flex justify-center items-center gap-2">
            &copy; <span id="year"></span> net.bunorden.com.
            <a href="mailto:contact@bunorden.com" class="text-slate-500 hover:text-slate-800 hover:underline transition font-medium">Contact</a>
            <span class="text-gray-300">|</span>
            <button onclick="openPrivacy()" class="text-slate-500 hover:text-slate-800 hover:underline transition font-medium">Privacy Policy</button>
        </p>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // --- 0. UI & PRIVACY LOGIC ---
    document.getElementById('year').innerText = new Date().getFullYear();
    document.getElementById('policy-date').innerText = new Date().toLocaleDateString();

    function openPrivacy() {
        const modal = document.getElementById('privacy-modal');
        const content = document.getElementById('privacy-content');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closePrivacy() {
        const modal = document.getElementById('privacy-modal');
        const content = document.getElementById('privacy-content');
        modal.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    // --- NEW: TIMEZONE MODAL LOGIC ---
    function showTzModal() {
        const m = document.getElementById('tz-modal');
        const content = m.querySelector('div'); // inner container

        // Calculate Data
        const d = new Date();
        const sysRegion = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const offset = -d.getTimezoneOffset();
        const sign = offset >= 0 ? '+' : '-';
        const pad = n => String(Math.floor(Math.abs(n))).padStart(2, '0');
        const utcStr = `UTC${sign}${pad(offset/60)}:${pad(offset%60)}`;

        // Populate
        document.getElementById('modal-utc').innerText = utcStr;
        document.getElementById('modal-region').innerText = sysRegion;
        document.getElementById('modal-local').innerText = d.toString();
        document.getElementById('modal-global').innerText = d.toUTCString();

        // --- FILTER & DISPLAY REGIONS WITH SAME OFFSET ---
        const listEl = document.getElementById('modal-all-regions');
        const listTitle = document.getElementById('modal-regions-title');
        listEl.innerHTML = '';

        if (typeof Intl.supportedValuesOf !== 'undefined') {
            try {
                // Helper to get consistent offset string (e.g. "GMT+09:00")
                const getOffsetStr = (z) => {
                    try {
                        return new Intl.DateTimeFormat('en-US', { timeZone: z, timeZoneName: 'longOffset' })
                            .formatToParts(d)
                            .find(p => p.type === 'timeZoneName').value;
                    } catch(e) { return ''; }
                };

                const targetOffsetStr = getOffsetStr(sysRegion);
                const allTz = Intl.supportedValuesOf('timeZone');

                // Filter
                const matching = allTz.filter(tz => getOffsetStr(tz) === targetOffsetStr);

                // Update Title
                if(listTitle) listTitle.innerText = `Regions matching ${utcStr} (${matching.length})`;

                const frag = document.createDocumentFragment();
                matching.forEach(tz => {
                    const li = document.createElement('li');
                    li.textContent = tz;
                    // Highlight the current one
                    if(tz === sysRegion) {
                        li.className = "font-bold text-blue-600 bg-blue-50 px-1 rounded -ml-1";
                    }
                    frag.appendChild(li);
                });
                listEl.appendChild(frag);
            } catch(e) {
                listEl.innerHTML = '<li>Error calculating offsets.</li>';
                console.error(e);
            }
        } else {
            listEl.innerHTML = '<li>Not supported in this browser.</li>';
        }

        // Animate
        m.classList.remove('hidden');
        setTimeout(() => {
            m.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closeTz() {
        const m = document.getElementById('tz-modal');
        const content = m.querySelector('div');
        m.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            m.classList.add('hidden');
        }, 300);
    }

    // --- NEW: USER AGENT MODAL LOGIC (Renamed to OS Modal) ---
    function showOsModal() {
        const m = document.getElementById('os-modal');
        const content = m.querySelector('div');
        m.classList.remove('hidden');
        setTimeout(() => {
            m.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closeOsModal() {
        const m = document.getElementById('os-modal');
        const content = m.querySelector('div');
        m.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            m.classList.add('hidden');
        }, 300);
    }

    // --- NEW: BROWSER MODAL LOGIC ---
    function showBrowserModal() {
        const m = document.getElementById('browser-modal');
        const content = m.querySelector('div');
        m.classList.remove('hidden');
        setTimeout(() => {
            m.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closeBrowserModal() {
        const m = document.getElementById('browser-modal');
        const content = m.querySelector('div');
        m.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            m.classList.add('hidden');
        }, 300);
    }

    // --- NEW: VPN MODAL LOGIC ---
    function showVpnModal() {
        const m = document.getElementById('vpn-modal');
        const content = m.querySelector('div');

        // Populate the raw string immediately before showing the modal
        const info = getCombinedInfo();
        document.getElementById('vpn-raw-string').innerText = info.combinedName;

        m.classList.remove('hidden');
        setTimeout(() => {
            m.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closeVpnModal() {
        const m = document.getElementById('vpn-modal');
        const content = m.querySelector('div');
        m.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            m.classList.add('hidden');
        }, 300);
    }

    // --- NEW: REPORT MIS-DETECTION LOGIC ---
    function reportMisdetection() {
        const ip = document.getElementById('ipv4-display').innerText || 'N/A';
        const status = document.getElementById('vpn-status').innerText || 'N/A';
        const provider = document.getElementById('vpn-provider-name').innerText || 'N/A';
        const asn = document.getElementById('asn-display').innerText || 'N/A';
        const rawString = document.getElementById('vpn-raw-string').innerText || 'N/A';

        const subject = `VPN Detection Issue Report - ${ip}`;
        const body = `
        I believe the VPN detection result is incorrect (False Positive or False Negative).

        --- Detected Information ---
        Public IP: ${ip}
        Detected Status: ${status}
        Detected Provider: ${provider}
        ASN: ${asn}
        Raw String: ${rawString}

        --- My Details (Please fill out) ---
        I am/am not using a VPN or Proxy:
        My actual ISP (if known):
        What should the status be:

        --- Description of Issue ---

        `;

        const mailtoLink = `mailto:contact@bunorden.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body.trim())}`;
        window.open(mailtoLink, '_blank');
    }

    // --- NEW: SPEED MODAL LOGIC ---
    let lastSpeedData = null; // Store results

    function showSpeedModal() {
        const m = document.getElementById('speed-modal');
        const content = m.querySelector('div');

        // Populate if data exists, otherwise show defaults
        if(lastSpeedData) {
            document.getElementById('modal-dl').innerText = lastSpeedData.dl;
            document.getElementById('modal-ul').innerText = lastSpeedData.ul;
            document.getElementById('modal-ping').innerText = lastSpeedData.ping + " ms";
            document.getElementById('modal-jitter').innerText = lastSpeedData.jitter + " ms";

            // Calculate Grade
            const dlVal = parseFloat(lastSpeedData.dl);
            const pingVal = parseInt(lastSpeedData.ping);
            let grade = "F";
            let color = "text-red-500";

            if(dlVal > 500 && pingVal < 20) { grade="A+"; color="text-emerald-500"; }
            else if(dlVal > 100 && pingVal < 50) { grade="A"; color="text-emerald-500"; }
            else if(dlVal > 50 && pingVal < 100) { grade="B"; color="text-blue-500"; }
            else if(dlVal > 10 && pingVal < 150) { grade="C"; color="text-orange-500"; }
            else if(dlVal > 1) { grade="D"; color="text-orange-600"; }

            const gradeEl = document.getElementById('net-grade');
            gradeEl.innerText = grade;
            gradeEl.className = `text-3xl font-black ${color}`;

            // Capabilities
            document.getElementById('badge-4k').className = (dlVal > 25) ? "px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-[10px] font-bold" : "opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold";
            document.getElementById('badge-1080p').className = (dlVal > 5) ? "px-2 py-1 bg-blue-100 text-blue-700 rounded text-[10px] font-bold" : "opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold";
            document.getElementById('badge-720p').className = (dlVal > 2) ? "px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-[10px] font-bold" : "opacity-30 px-2 py-1 bg-slate-200 text-slate-500 rounded text-[10px] font-bold";

            document.getElementById('modal-ploss').innerText = lastSpeedData.ploss;
        }

        m.classList.remove('hidden');
        setTimeout(() => {
            m.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }, 10);
    }

    function closeSpeedModal() {
        const m = document.getElementById('speed-modal');
        const content = m.querySelector('div');
        m.classList.add('opacity-0');
        content.classList.add('scale-95');
        setTimeout(() => {
            m.classList.add('hidden');
        }, 300);
    }

    // --- 1. COOKIE LOGIC ---
    function setCookie(n, v, d) { let e=""; if(d){const dt=new Date();dt.setTime(dt.getTime()+(d*24*60*60*1000));e="; expires="+dt.toUTCString();} document.cookie=n+"="+(v||"")+e+"; path=/"; }
    function getCookie(n) { const ne=n+"="; const ca=document.cookie.split(';'); for(let i=0;i<ca.length;i++){ let c=ca[i]; while(c.charAt(0)==' ') c=c.substring(1,c.length); if(c.indexOf(ne)==0) return c.substring(ne.length,c.length); } return null; }

    function showConsentModal() { const m=document.getElementById('cookie-modal'); const c=document.getElementById('cookie-content'); m.classList.remove('hidden'); setTimeout(()=>{m.classList.remove('opacity-0');c.classList.remove('scale-95');},50); }
    function hideConsentModal() { const m=document.getElementById('cookie-modal'); m.classList.add('opacity-0'); setTimeout(()=>{m.classList.add('hidden');},300); }
    function handleConsent(a) { const v=a?'accepted':'declined'; setCookie('speedtest_consent',v,365); hideConsentModal(); if(!a){ setCookie('speedtest_history',"",-1); } updateConsentStatus(v); renderHistory(); }
    function disableHistory() { setCookie('speedtest_consent','declined',365); setCookie('speedtest_history',"",-1); updateConsentStatus('declined'); renderHistory(); }

    function updateConsentStatus(s) {
        const l=document.getElementById('consent-status'), be=document.getElementById('btn-enable-history'), bd=document.getElementById('btn-disable-history'), bc=document.getElementById('btn-clear-history');
        if(s==='accepted'){ l.innerText="Active"; l.className="px-2 py-1.5 rounded bg-emerald-100 text-emerald-600 font-bold"; be.classList.add('hidden'); bd.classList.remove('hidden'); bc.classList.remove('hidden'); }
        else { l.innerText="Disabled"; l.className="px-2 py-1.5 rounded bg-gray-100 text-gray-500 font-bold"; be.classList.remove('hidden'); bd.classList.add('hidden'); bc.classList.add('hidden'); }
    }

    // --- NEW: HISTORY LIMIT LOGIC ---
    function getHistoryLimit() {
        const el = document.getElementById('history-limit-select');
        if(el) return parseInt(el.value);
        const c = getCookie('history_limit_val');
        return c ? parseInt(c) : 50; // Default to Max/All
    }

    function updateHistoryLimit() {
        const val = document.getElementById('history-limit-select').value;
        setCookie('history_limit_val', val, 365);
        trimHistory(parseInt(val));
    }

    function trimHistory(limit) {
        let h=getCookie('speedtest_history');
        try{h=h?JSON.parse(h):[];}catch(e){h=[];}
        if(h.length > limit) {
            h = h.slice(0, limit);
            setCookie('speedtest_history',JSON.stringify(h),30);
            renderHistory();
        }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
        const c=getCookie('speedtest_consent');
        if(!c){showConsentModal(); updateConsentStatus(null);}else{updateConsentStatus(c);}

        // Initialize Dropdown
        const lim = getCookie('history_limit_val');
        if(lim) document.getElementById('history-limit-select').value = lim;

        renderHistory();
    });

    // UPDATED SAVE RESULT FUNCTION
    function saveResult(p, d, u, s, prov) { // Added 'prov' (Provider) parameter
        if (getCookie('speedtest_consent') !== 'accepted') return;
        let h = getCookie('speedtest_history');
        try { h = h ? JSON.parse(h) : []; } catch (e) { h = []; }

        const ip = document.getElementById('ipv4-display').innerText || '--';
        const isp = document.getElementById('isp-display').innerText || '--';

        const dateObj = new Date();
        const f = (x) => String(x).padStart(2, '0');
        const timeStr = `${f(dateObj.getHours())}:${f(dateObj.getMinutes())}`;
        const dateStr = `${f(dateObj.getDate())}/${f(dateObj.getMonth() + 1)}/${dateObj.getFullYear()}`;

        const offset = -dateObj.getTimezoneOffset();
        const sign = offset >= 0 ? '+' : '-';
        const pad = n => String(Math.floor(Math.abs(n))).padStart(2, '0');
        const utcStr = `UTC${sign}${pad(offset / 60)}:${pad(offset % 60)}`;

        const fullDate = `${timeStr} ${dateStr} (${utcStr})`;

        // Store Provider AND Server
        h.unshift({
            date: fullDate,
            ping: p,
            dl: d,
            ul: u,
            ip: ip,
            isp: isp,
            server: s || 'Unknown',
            provider: prov || 'Unknown' // New Field
        });

        const limit = getHistoryLimit();
        while (h.length > limit) h.pop();

        setCookie('speedtest_history', JSON.stringify(h), 30);
        renderHistory();
    }

    function clearHistory(){ setCookie('speedtest_history',"",-1); renderHistory(); }

    // UPDATED RENDER HISTORY FUNCTION
    function renderHistory() {
        const tb = document.getElementById('history-table-body'), c = getCookie('speedtest_consent');
        if (c !== 'accepted') {
            tb.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-400"><p class="italic mb-2">History disabled.</p><button onclick="showConsentModal()" class="text-blue-500 underline font-medium">Enable</button></td></tr>`;
            return;
        }
        let h = getCookie('speedtest_history');
        try { h = h ? JSON.parse(h) : []; } catch (e) { h = []; }

        if (h.length === 0) {
            tb.innerHTML = `<tr><td colspan="7" class="px-4 py-4 text-center text-gray-400 italic">No history found.</td></tr>`;
            return;
        }

        let ht = '';
        h.forEach(i => {
            // Fallback for old records that didn't have a provider saved
            const providerDisplay = i.provider ? i.provider : 'Cloudflare';

            ht += `<tr class="hover:bg-gray-50 transition">
                <td class="px-4 py-2 font-mono text-gray-500 text-xs">${i.date}</td>
                <td class="px-4 py-2 font-mono text-xs text-slate-600">${i.ip || '-'}</td>
                <td class="px-4 py-2 text-xs text-slate-600 max-w-[120px] truncate" title="${i.isp || ''}">${i.isp || '-'}</td>

                <td class="px-4 py-2 text-xs">
                    <div class="font-bold text-slate-700">${providerDisplay}</div>
                    <div class="text-[10px] text-gray-400 font-mono">${i.server || '-'}</div>
                </td>

                <td class="px-4 py-2 font-bold">${i.ping}</td>
                <td class="px-4 py-2 font-bold text-blue-600">${i.dl}</td>
                <td class="px-4 py-2 font-bold text-purple-600">${i.ul}</td>
            </tr>`;
        });
        tb.innerHTML = ht;
    }

    function clearHistory(){ setCookie('speedtest_history',"",-1); renderHistory(); }

    // --- 2. MULTI-THREADED SPEEDTEST ENGINE ---
    function updateGauge(v, l, u=false) {
        const gv=document.getElementById('gauge-value'), gl=document.getElementById('gauge-label'), gf=document.getElementById('speed-gauge');
        gv.innerText=v; gl.innerText=l; gf.style.stroke=u?"#9333ea":"#10b981";
        let p=(v/100)*100; if(p>100)p=100; gf.style.strokeDasharray=`${p}, 100`;
    }

    // --- ANIMATION TOGGLE LOGIC ---
    let animationEnabled = true;
    // Note: Toggle functionality removed from UI, defaulting to true.

    // --- STOP SPEEDTEST LOGIC ---
    let speedTestAbortController = null;

    async function fetchStream(url, duration, updateCallback, signal) {
        const start = performance.now();
        let loaded = 0;
        try {
            const response = await fetch(url, { signal });
            const reader = response.body.getReader();
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                loaded += value.length;
                if (performance.now() - start > duration) { reader.cancel(); break; }
                updateCallback(loaded);
            }
        } catch (e) {
            if (e.name !== 'AbortError') throw e;
        }
        return loaded;
    }

    function stopSpeedTest() {
        if(speedTestAbortController) {
            speedTestAbortController.abort();
            speedTestAbortController = null;
            document.getElementById('test-state').innerText = "Stopped";
            document.getElementById('test-state').className = "text-xs font-bold text-red-500";
            document.getElementById('speed-status-icon').className = "p-2 bg-gray-50 rounded-lg text-gray-400";
            document.getElementById('speed-gauge').classList.remove('gauge-pulse');
            document.getElementById('gauge-container').classList.remove('active-anim');
        }
    }

    async function runHighPerformanceTest() {
        // --- SETUP ---
        const btnStart = document.getElementById('btn-card-speed');
        const btnStop = document.getElementById('btn-stop-speed');
        btnStart.classList.add('hidden');
        btnStop.classList.remove('hidden');

        speedTestAbortController = new AbortController();
        const signal = speedTestAbortController.signal;

        const status = document.getElementById('test-state');
        const bar = document.getElementById('speed-progress');
        const icon = document.getElementById('speed-status-icon');
        const dlEl = document.getElementById('dl-final');
        const ulEl = document.getElementById('ul-final');
        const pgEl = document.getElementById('ping-value');
        const serverLoc = document.getElementById('server-location');
        const gaugeFill = document.getElementById('speed-gauge');
        const gaugeContainer = document.getElementById('gauge-container');

        // Reset
        dlEl.innerText = "-- Mbps"; ulEl.innerText = "-- Mbps"; bar.style.width = "0%";
        updateGauge(0, "Ready");

        if (animationEnabled) {
            icon.className = "p-2 bg-emerald-50 rounded-lg text-emerald-600 blink";
            gaugeFill.classList.add('gauge-pulse');
            gaugeContainer.classList.add('active-anim');
        }

        function calculateSpeed(currentBytes, startBytes, currentTime, startTime) {
            const bytesDiff = currentBytes - startBytes;
            const timeDiff = (currentTime - startTime) / 1000;
            if (timeDiff <= 0) return 0;
            return ((bytesDiff * 8) / timeDiff / 1024 / 1024).toFixed(1);
        }

        let fP = "--", fD = "--", fU = "--";
        let jitterVal = "0";
        let detectedServer = "Unknown";
        const detectedProvider = "Cloudflare"; // Hardcoded Provider Name

        try {
            // PHASE 1: LATENCY
            status.innerText = "Measuring Latency...";
            const pings = [];
            for (let i = 0; i < 10; i++) {
                try {
                    const pS = performance.now();
                    await fetch('https://speed.cloudflare.com/cdn-cgi/trace?r=' + Math.random(), { signal });
                    const pE = performance.now();
                    pings.push(pE - pS);
                } catch (e) { if (signal.aborted) throw e; }
            }

            if (pings.length > 0) {
                pings.sort((a, b) => a - b);
                if (pings.length > 4) { pings.pop(); pings.shift(); }
                const avgPing = pings.reduce((a, b) => a + b, 0) / pings.length;
                const variance = pings.reduce((a, b) => a + Math.pow(b - avgPing, 2), 0) / pings.length;
                jitterVal = Math.sqrt(variance).toFixed(1);
                fP = Math.round(avgPing);
                pgEl.innerText = fP + " ms";
            }

            // GET SERVER LOCATION
            await fetch('https://speed.cloudflare.com/cdn-cgi/trace', { signal })
                .then(r => r.text())
                .then(t => {
                    const loc = t.match(/loc=(.+)/)?.[1] || "UNK";
                    const colo = t.match(/colo=(.+)/)?.[1] || "UNK";
                    detectedServer = `${colo} (${loc})`;
                    serverLoc.innerHTML = `${colo} <span class="text-gray-400 font-normal">(${loc})</span>`;
                }).catch(() => {});

            // PHASE 2: DOWNLOAD
            status.innerText = "Downloading (Warm-up)...";
            const dlDuration = 15000; // Increased duration for accuracy
            const warmUpTime = 4000;  // Increased warm-up time
            const dlUrl = "https://speed.cloudflare.com/__down?bytes=50000000";
            let dlStartTime = performance.now();
            let dlTotalBytes = 0;
            let dlWarmUpDone = false;
            let dlBytesAtWarmUp = 0;
            let dlTimeAtWarmUp = 0;

            const dlPromises = Array(6).fill(0).map(async () => {
                while ((performance.now() - dlStartTime) < dlDuration) {
                    try {
                        const response = await fetch(dlUrl + "&r=" + Math.random(), { signal });
                        const reader = response.body.getReader();
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            dlTotalBytes += value.length;
                            if ((performance.now() - dlStartTime) > dlDuration) { reader.cancel(); return; }
                        }
                    } catch (e) { return; }
                }
            });

            const dlTimer = setInterval(() => {
                if (signal.aborted) { clearInterval(dlTimer); return; }
                const now = performance.now();
                const elapsed = now - dlStartTime;
                if (!dlWarmUpDone && elapsed > warmUpTime) {
                    dlWarmUpDone = true;
                    dlBytesAtWarmUp = dlTotalBytes;
                    dlTimeAtWarmUp = now;
                    status.innerText = "Downloading (Measuring)...";
                }
                if (elapsed > 500) {
                    let currentSpeed = 0;
                    if (dlWarmUpDone) currentSpeed = calculateSpeed(dlTotalBytes, dlBytesAtWarmUp, now, dlTimeAtWarmUp);
                    else currentSpeed = calculateSpeed(dlTotalBytes, 0, now, dlStartTime);
                    updateGauge(currentSpeed, "Mbps (Down)");
                    bar.style.width = Math.min((elapsed / dlDuration) * 50, 50) + "%";
                }
            }, 100);

            await Promise.all(dlPromises);
            clearInterval(dlTimer);
            if (signal.aborted) throw new Error('Aborted');

            fD = calculateSpeed(dlTotalBytes, dlBytesAtWarmUp, performance.now(), dlTimeAtWarmUp) + " Mbps";
            dlEl.innerText = fD;

            // PHASE 3: UPLOAD
            status.innerText = "Uploading (Warm-up)...";
            updateGauge(0, "Mbps (Up)", true);
            const ulDuration = 12000; // Increased duration for accuracy
            // warmUpTime remains 4000
            const upChunkSize = 2 * 1024 * 1024;
            const blob = new Blob([new Uint8Array(upChunkSize)]);
            let ulStartTime = performance.now();
            let ulTotalBytes = 0;
            let ulWarmUpDone = false;
            let ulBytesAtWarmUp = 0;
            let ulTimeAtWarmUp = 0;

            const ulPromises = Array(4).fill(0).map(async () => {
                while ((performance.now() - ulStartTime) < ulDuration) {
                    try {
                        await fetch("https://speed.cloudflare.com/__up", { method: "POST", body: blob, signal });
                        ulTotalBytes += upChunkSize;
                    } catch (e) { return; }
                }
            });

            const ulTimer = setInterval(() => {
                if (signal.aborted) { clearInterval(ulTimer); return; }
                const now = performance.now();
                const elapsed = now - ulStartTime;
                if (!ulWarmUpDone && elapsed > warmUpTime) {
                    ulWarmUpDone = true;
                    ulBytesAtWarmUp = ulTotalBytes;
                    ulTimeAtWarmUp = now;
                    status.innerText = "Uploading (Measuring)...";
                }
                if (elapsed > 500) {
                    let currentSpeed = 0;
                    if (ulWarmUpDone) currentSpeed = calculateSpeed(ulTotalBytes, ulBytesAtWarmUp, now, ulTimeAtWarmUp);
                    else currentSpeed = calculateSpeed(ulTotalBytes, 0, now, ulStartTime);
                    updateGauge(currentSpeed, "Mbps (Up)", true);
                    bar.style.width = 50 + Math.min((elapsed / ulDuration) * 50, 50) + "%";
                }
            }, 100);

            await Promise.all(ulPromises);
            clearInterval(ulTimer);
            if (signal.aborted) throw new Error('Aborted');

            if (ulTotalBytes > 0) {
                fU = calculateSpeed(ulTotalBytes, ulBytesAtWarmUp, performance.now(), ulTimeAtWarmUp) + " Mbps";
                ulEl.innerText = fU;
            } else {
                fU = "Failed (CORS)";
                ulEl.innerText = "Blocked";
            }

            status.innerText = "Complete";
            status.className = "text-xs font-bold text-emerald-600";
            bar.style.width = "100%";
            icon.className = "p-2 bg-emerald-50 rounded-lg text-emerald-600";
            gaugeFill.classList.remove('gauge-pulse');
            gaugeContainer.classList.remove('active-anim');

            lastSpeedData = { dl: fD, ul: fU, ping: fP, jitter: jitterVal, ploss: "0% (Estimated)" };

            // PASS DETECTED PROVIDER TO SAVE FUNCTION
            saveResult(fP + " ms", fD, fU, detectedServer, detectedProvider);

        } catch (e) {
            if (e.message === 'Aborted' || e.name === 'AbortError') {
                status.innerText = "Stopped";
                status.className = "text-xs font-bold text-orange-500";
            } else {
                console.error(e);
                status.innerText = "Error";
                status.className = "text-xs font-bold text-red-600";
            }
            icon.className = "p-2 bg-gray-50 rounded-lg text-gray-400";
            gaugeFill.classList.remove('gauge-pulse');
            gaugeContainer.classList.remove('active-anim');
        } finally {
            btnStart.classList.remove('hidden');
            btnStop.classList.add('hidden');
        }
    }
    // --- NEW: Refresh/Relocate Server Function ---
    async function refreshServerLocation() {
        const locEl = document.getElementById('server-location');
        const icon = document.getElementById('server-refresh-icon');

        // 1. Visual Loading State
        if(icon) icon.classList.add('fa-spin');
        locEl.innerHTML = "Locating...";
        locEl.className = "font-bold text-gray-400 italic";

        try {
            // 2. Force fresh fetch (bypass cache with Math.random)
            const r = await fetch('https://speed.cloudflare.com/cdn-cgi/trace?r=' + Math.random());
            const t = await r.text();

            // 3. Parse Data
            const loc = t.match(/loc=(.+)/)?.[1] || "UNK";
            const colo = t.match(/colo=(.+)/)?.[1] || "UNK";

            // 4. Update UI
            locEl.innerHTML = `${colo} <span class="text-gray-400 font-normal">(${loc})</span>`;
            locEl.className = "font-bold text-slate-700";

        } catch (e) {
            locEl.innerText = "Error (Blocked)";
            locEl.className = "font-bold text-red-500";
        } finally {
            // 5. Stop Animation
            if(icon) icon.classList.remove('fa-spin');
        }
    }

    // --- NEW HELPER FUNCTION TO GET COMBINED INFO FOR MODAL ---
    function getCombinedInfo() {
        const isp = document.getElementById('isp-display').innerText || 'N/A';
        const org = document.getElementById('org-display').innerText || 'N/A';
        const asn = document.getElementById('asn-display').innerText || 'N/A';

        // Match the logic in detectVPN for combinedName, but keep original case for display
        const combinedName = `${isp} ${org} ${asn}`;

        return { isp, org, asn, combinedName: combinedName.toLowerCase() };
    }

    // --- 3. VPN & SYSTEM UTILS ---
    const KNOWN_VPN_ASNS = new Set([
        // --- TIER 1: COMMERCIAL VPN BRANDS ---
        209854, // Surfshark (Cyberzone)
        216025, // Mullvad VPN
        39351,  // Mullvad (31173 Services AB)
        209103, 62371, 199218, 57169, // ProtonVPN (Proton AG)
        136787, 147049, 141039, 207137, 211366, // NordVPN (Packethub S.A.)
        137409, // ExpressVPN (LogicWeb/GSL)
        47583,  // ExpressVPN (HostRoyale)
        397223, // ExpressVPN (Datacamp)
        60341,  // TunnelBear

        // --- TIER 2: SHARED VPN BACKBONES ---
        9009, 212238, 201814, // M247 Group
        60068, 212238, 42473, // Datacamp / CDN77 / DataPacket
        16265, 28753, 395954, 60626, 57043, 18779, // Leaseweb
        54095, 137409, 11878, // GSL Networks & Tzulo
        33438, 12989, 54600, 30635, 6939, // NetProtect / Stackpath

        // --- TIER 3: CLOUD VPS PROVIDERS (Self-Hosted/Generic) ---
        14061, 202018, 62567, 393406, // DigitalOcean
        20473, 64515, 206443, // The Constant Company (Vultr)
        63949, 21844, 17204, // Akamai / Linode
        16276, 35540, 9989, // OVH SAS
        24940, 213230, 47232, // Hetzner Online
        16509, 14618, 7224, 8987, // Amazon AWS
        15169, 396982, 19527, // Google Cloud
        8075, 8074, // Microsoft Azure
        31898, // Oracle Cloud

        // --- TIER 4: HIGH-RISK HOSTING & PROXY NETWORKS (EXPANDED) ---
        13335,  // Cloudflare (WARP / iCloud Relay)
        53667,  // FranTech (BuyVM)
        202425, // IP Volume
        132203, // Tencent Cloud
        49335,  // Rayo Byte (Residential Proxies)
        40021,  // Contabo
        262287, // Latitude.sh
        396356, // Latitude.sh
        21859,  // Zenlayer
        203020, // HostRoyale
        22363,  // Powerhouse Management
        136557, // Host Universal
        8100,   // QuadraNet
        40676,  // Psychz Networks
        395092, // Shock Hosting
        19318,  // Intergrid
        29802,  // Hivelocity
        14618,  // Fastly

        // --- NEW ADDITIONS ---
        41281,  // AS41281 (Keff Networks infra)
        215551, // AS215551 (Keff Networks infra)
        398327, // Telenor Norge AS (High-risk hosting)
        394353, // Hostwinds (Hosting/Proxy)
        34988,  // QuadraNet (High-risk colo/Hosting)
        54314,  // Pexigo (Proxy)
        398284, // Zomro B.V. (Hosting/Proxy)
        // --- CUSTOMER REQUESTED ADDITIONS ---
        54113, // Fastly, Inc. (CDN/iCloud Private Relay)
        23959, // Owl Limited (Hosting/Mullvad Infra)
        43357 // Owl Limited (Hosting/Mullvad Infra)
    ]);

    // --- UPDATED: Comprehensive VPN Brand Mapping (EXPANDED) ---
    // Format: "Likely [VPN Names] - [ASN/Infra]"
    const VPN_BRAND_MAP = [
        // --- TIER 1: SPECIFIC COMMERCIAL BRANDS (Highest Accuracy) ---
        { keys: ['london trust media', 'private internet access'], label: 'Likely PIA - London Trust Media' },
        { keys: ['proton ag', 'protonvpn'], label: 'Likely ProtonVPN - Proton AG' },
        { keys: ['mullvad', '31173 services', 'amnezia'], label: 'Likely Mullvad - 31173 Services' },
        { keys: ['cyberzone', 'surfshark'], label: 'Likely Surfshark - Cyberzone' },
        { keys: ['packethub', 'nordvpn'], label: 'Likely NordVPN - Packethub' },
        { keys: ['expressvpn', 'expressnetw'], label: 'Likely ExpressVPN - ExpressNetw' },
        { keys: ['logicweb'], label: 'Likely ExpressVPN - LogicWeb' },
        { keys: ['aura', 'anchorfree', 'pango', 'hotspot shield'], label: 'Likely Hotspot Shield - Aura/Pango' },
        { keys: ['golden frog', 'vyprvpn'], label: 'Likely VyprVPN - Golden Frog' },
        { keys: ['zenmate', 'zenguard'], label: 'Likely ZenMate - Zenguard' },
        { keys: ['windscribe'], label: 'Likely Windscribe - Windscribe' },
        { keys: ['tunnelbear'], 'label': 'Likely TunnelBear - TunnelBear' },
        { keys: ['hide.me', 'hide me'], label: 'Likely Hide.me - Hide-me' },
        { keys: ['privax', 'hidemyass', 'hma'], label: 'Likely HMA (HideMyAss) - Privax' },
        { keys: ['gz systems', 'gaditek', 'purevpn', 'secure internet'], label: 'Likely PureVPN - GZ Systems' },
        { keys: ['peakstar', 'atlas'], label: 'Likely Atlas VPN - Peakstar' },
        { keys: ['ivpn'], label: 'Likely IVPN - IVPN' },
        { keys: ['ovpn'], label: 'Likely OVPN - OVPN' },
        { keys: ['airvpn'], label: 'Likely AirVPN - AirVPN' },
        { keys: ['torguard'], label: 'Likely TorGuard - TorGuard' },

        // --- TIER 2: SPECIFIC INFRASTRUCTURE REQUESTS (Tor/Anonymity) ---

        // NEW ENTRY: Keff Networks Ltd
        { keys: ['keff networks ltd', 'keff networks'], label: 'Possibly Tor Network / Datacenter - Keff Networks Ltd' },

        // NEW ENTRY: Foundation for Applied Privacy
        { keys: ['foundation for applied privacy', 'applied privacy'], label: 'Likely Tor Network - Foundation for Applied Privacy' },

        // NEW ENTRY: 1337 Services GmbH
        { keys: ['1337 services gmbh', '1337 services'], label: 'Possibly Tor Network / Datacenter - 1337 Services GmbH' },

        // NEW ENTRY: FlokiNET ehf
        { keys: ['flokinet ehf', 'flokinet'], label: 'Possibly Tor Network / Datacenter - FlokiNET ehf' },

        // NEW ENTRY: QuxLabs AB
        { keys: ['quxlabs ab', 'quxlabs'], label: 'Possibly Tor Network / Datacenter - QuxLabs AB' },

        // NEW ENTRY: Dotsrc
        { keys: ['dotsrc', 'forening for dotsrc'], label: 'Possibly Tor Network / Datacenter - Dotsrc' },

        // NEW ENTRY: Stiftung Erneuerbare Freiheit
        { keys: ['stiftung erneuerbare freiheit', 'erneur freih'], label: 'Likely Tor Network - Stiftung Erneuerbare Freiheit' },

        // NEW ENTRY: Online.net
        { keys: ['online.net', 'online sas'], label: 'Likely Tor Network - Online.net' },

        // NEW ENTRY: 100UP
        { keys: ['100up'], label: 'Likely Tor Network - 100UP' },

        // NEW ENTRY: IELO LIAZO SERVICES SAS
        { keys: ['ielo liazo', 'lazo services'], label: 'Likely Tor Network - IELO LIAZO' },

        // NEW ENTRY: Host Universal
        { keys: ['host universal'], label: 'Possible Surfshark - Host Universal' },

        // NEW ENTRIES: High-Risk Hosting/Proxy
        { keys: ['pexigo', 'zomro', 'dedipath', 'hostwinds'], label: 'Generic Hosting / Proxy Network - High Risk' },
        { keys: ['telenor'], label: 'Generic Hosting / Anonymity Service - Telenor' },

        // --- CUSTOMER REQUESTED ADDITIONS ---
        { keys: ['owl limited', 'asn23959', 'asn43357'], label: 'Likely Mullvad/Proton - Owl Limited/AS' },


        // --- TIER 3: SHARED INFRASTRUCTURE GROUPS ---
        // Datacamp (Updated)
        { keys: ['datacamp', 'cdn77', 'datapacket'], label: 'Likely Surfshark/PIA/Proton - Datacamp' },
        // Estnoc
        { keys: ['estnoc'], label: 'Datacenter / Possibly Nord/Surfshark/Proton - Estnoc' },
        // Orion
        { keys: ['orion'], label: 'Datacenter / Possibly Proton - Orion' },
        // xTom
        { keys: ['xtom'], label: 'Datacenter / Possibly Proton - xTom' },
        // NetProtect/Stackpath group
        { keys: ['strong technology', 'strongvpn', 'ipvanish', 'netprotect', 'highwinds', 'stackpath', 'performive'], label: 'Likely StrongVPN/IPVanish - NetProtect' },
        // M247 group
        { keys: ['m247', 'm europe', 'ipxo'], label: 'Likely Nord/Surfshark/Proton - M247' },
        // GSL group
        { keys: ['tzulo', 'gsl networks'], label: 'Likely PureVPN/CyberGhost - GSL' },
        // Clouvider group
        { keys: ['clouvider'], label: 'Likely ExpressVPN/FastestVPN - Clouvider' },
        // Leaseweb
        { keys: ['leaseweb'], label: 'Likely PIA/PrivateVPN - Leaseweb' },

        // --- UPDATED CDN/RELAY ENTRIES ---
        // Cloudflare (Updated per request)
        { keys: ['cloudflare', 'warp', 'asn13335'], label: 'Usually WARP / iCloud Private Relay - Cloudflare Inc.' },
        // Fastly (Updated per request)
        { keys: ['fastly', 'asn54113'], label: 'Probably WARP / iCloud Private Relay - Fastly Inc.' },
        // Akamai (Updated per request)
        { keys: ['akamai'], label: 'Maybe iCloud Private Relay / Surfshark / Proton - Akamai Technologies' },


        // --- TIER 4: GENERIC CLOUD/VPS ---
        { keys: ['google', 'google llc'], label: 'Likely Google One VPN - Google Cloud' },
        { keys: ['constant', 'vultr', 'choopa'], label: 'Likely IPVanish/Self-Hosted - Vultr' },
        { keys: ['digitalocean'], label: 'Likely Self-Hosted VPN - DigitalOcean' },
        { keys: ['linode'], label: 'Likely Tor Network / Self-Hosted VPN - Linode' },
        { keys: ['ovh', 'ovh sas'], label: 'Likely Self-Hosted VPN - OVH' },
        { keys: ['hetzner'], label: 'Likely Self-Hosted VPN - Hetzner' },
        { keys: ['amazon', 'aws'], label: 'Likely AWS VPN - AWS' },
        { keys: ['microsoft', 'azure'], label: 'Likely Azure VPN - Azure' },
        { keys: ['oracle', 'oracle cloud'], label: 'Likely Oracle Cloud VPN - Oracle' },
        { keys: ['alibaba'], label: 'Likely Alibaba Cloud VPN - Alibaba' },

        // --- TIER 5: ANONYMITY NETWORKS ---
        { keys: ['tor exit', 'tor project', 'onion'], label: 'Tor Network - Tor Exit Node' },
        // --- NEW GENERIC HIGH-CONFIDENCE INDICATORS ---
        { keys: ['vpn service', 'privacy service', 'anonymous vpn'], label: 'Likely Generic VPN Service' },
        { keys: ['residential proxy', 'anonymous proxy'], label: 'Likely Proxy Network' }
    ];

    // Priority 2: Generic list of known providers/terms for regex matching
    const PROVIDER_NAMES = [
        'cloudflare', 'google', 'amazon', 'aws', 'microsoft', 'azure',
        'digitalocean', 'hetzner', 'ovh', 'expressvpn',
        'nordvpn', 'proton', 'surfshark', 'mullvad',
        'zenlayer', 'leaseweb', 'hostinger',
        'windscribe', 'tunnelbear', 'vyprvpn', 'purevpn', 'ipvanish',
        'hotspot shield', 'zenmate', 'hidemyass', 'hma', 'private internet access',
        'pia', 'cyberghost', 'strongvpn', 'fastestvpn', 'ivacy', 'veepn', 'torguard',
        'airvpn', 'perfectprivacy', 'cactusvpn', 'ovpn', 'hide.me',
        'privatevpn', 'protonvpn', 'vultr', 'linode', 'choopa', 'performive',
        'shock hosting', 'teraswitch', 'melbicom', 'packethub', 'datacamp',
        // CUSTOMER REQUESTED ADDITION
        'fastly', 'owl limited', 'akamai'
    ];

    // Compiled Regex for O(1) matching of strings
    const VPN_REGEX = new RegExp(PROVIDER_NAMES.join('|'), 'i');
    const GENERIC_REGEX = /vpn|proxy|hosting|cloud|datacenter|vps|server|transit|colo/i;

    function detectVPN(ipTz, ipUtc, isp, countryCode, org, asn) {
        const vpnEl = document.getElementById('vpn-status');
        const detailEl = document.getElementById('vpn-details');
        const badgeEl = document.getElementById('vpn-risk-badge');
        const fraudEl = document.getElementById('vpn-fraud-score');
        const providerNameEl = document.getElementById('vpn-provider-name');

        // System UTC Calculation
        const d = new Date();
        const offset = -d.getTimezoneOffset();
        const sign = offset >= 0 ? '+' : '-';
        const pad = n => String(Math.floor(Math.abs(n))).padStart(2, '0');
        const sysUtcStr = `UTC${sign}${pad(offset/60)}:${pad(offset%60)}`;
        const ipUtcStr = `UTC${ipUtc}`;

        let score = 0;
        const reasons = [];

        // Fast Prep
        const asnNum = parseInt(asn);
        const combinedName = (isp + " " + org + " " + asn).toLowerCase();

        // Define a set of ASNs that are common cloud platforms (Tier 3/4)
        // NOTE: Cloudflare ASN 13335 has been removed from this low-confidence set per user request.
        const LOW_CONFIDENCE_ASNS = new Set([
            14061, 202018, 62567, 393406, // DigitalOcean
            20473, 64515, 206443, // The Constant Company (Vultr)
            63949, 21844, 17204, // Akamai / Linode
            16276, 35540, 9989, // OVH SAS
            24940, 213230, 47232, // Hetzner Online
            16509, 14618, 7224, 8987, // Amazon AWS
            15169, 396982, 19527, // Google Cloud
            8075, 8074, // Microsoft Azure
            31898, // Oracle Cloud
        ]);

        // 1. Check Priority Mappings (VPN_BRAND_MAP) - High Confidence
        let matchedBrand = null;
        let isHighConfidence = false;
        for (const brand of VPN_BRAND_MAP) {
            if (brand.keys.some(k => combinedName.includes(k))) {
                matchedBrand = brand.label;
                score += 50; // High-Confidence Brand Match
                isHighConfidence = true;
                reasons.push(`Known Infra/Brand Match`);
                document.getElementById('icon-isp').className = "fas fa-exclamation-triangle text-red-500";
                document.getElementById('desc-isp').innerText = `Infra Matched: ${brand.keys[0]}`;
                break;
            }
        }

        let ispFlagged = isHighConfidence; // ISP is definitively flagged only by high-confidence match

        // 2. ASN Check (Differentiated Scoring)
        if (!isNaN(asnNum) && KNOWN_VPN_ASNS.has(asnNum)) {
            if (!isHighConfidence) {
                // Check if it's a dedicated VPN ASN (High Confidence) vs. a generic Cloud ASN (Low Confidence)
                if (LOW_CONFIDENCE_ASNS.has(asnNum)) {
                    score += 20; // Low-Confidence Cloud/Hosting ASN
                    reasons.push(`Cloud/Hosting ASN: ${asnNum}`);
                    document.getElementById('icon-isp').className = "fas fa-exclamation-circle text-orange-500";
                    document.getElementById('desc-isp').innerText = `Cloud/Hosting ASN: ${asnNum}`;
                } else {
                    // This catches dedicated VPN ASNs not covered by the brand map loop above
                    score += 50; // High-Confidence Dedicated VPN ASN (e.g., Mullvad)
                    reasons.push(`Dedicated VPN ASN: ${asnNum}`);
                    ispFlagged = true;
                    document.getElementById('icon-isp').className = "fas fa-exclamation-triangle text-red-500";
                    document.getElementById('desc-isp').innerText = `Flagged Dedicated ASN: ${asnNum}`;
                }
            }
        } else if (!ispFlagged) {
            // If ASN check failed, check if the generic Cloudflare ASN (13335) is the provider.
            // Since it's not in LOW_CONFIDENCE_ASNS, it gets the neutral check mark unless a keyword is found.
            if (asnNum === 13335) {
                document.getElementById('icon-isp').className = "fas fa-check-circle text-emerald-500";
                document.getElementById('desc-isp').innerText = "Standard CDN/Relay (Cloudflare)";
            }
        }

        // 3. String Match (Generic)
        if (!ispFlagged && VPN_REGEX.test(combinedName)) {
            score += 20; // Generic Name Match gets a lower score
            const match = combinedName.match(VPN_REGEX)[0];
            const formattedName = match.charAt(0).toUpperCase() + match.slice(1);
            matchedBrand = `${formattedName} Detected`;

            reasons.push(`Generic Provider Match: ${match}`);
            document.getElementById('icon-isp').className = "fas fa-exclamation-circle text-orange-500";
            document.getElementById('desc-isp').innerText = `Matched: ${formattedName}`;
        }

        // 4. Generic Heuristics (if nothing else hit)
        if (score === 0) {
            if (GENERIC_REGEX.test(combinedName)) {
                score += 20;
                reasons.push("Generic Hosting Keyword");
                document.getElementById('icon-isp').className = "fas fa-exclamation-circle text-orange-500";
                document.getElementById('desc-isp').innerText = "Generic Hosting Keyword";
            } else {
                document.getElementById('icon-isp').className = "fas fa-check-circle text-emerald-500";
                document.getElementById('desc-isp').innerText = "Residential/Standard ISP";
            }
        }


        // 5. Timezone Check
        if (ipUtcStr !== sysUtcStr) {
            score += 20;
            reasons.push("Timezone Mismatch");
            document.getElementById('icon-tz').className = "fas fa-exclamation-circle text-orange-500";
            document.getElementById('desc-tz').innerText = `IP: ${ipUtcStr} vs Sys: ${sysUtcStr}`;
        } else {
            document.getElementById('icon-tz').className = "fas fa-check-circle text-emerald-500";
            document.getElementById('desc-tz').innerText = "Matched";
        }

        // 6. Language Check
        const browserLang = navigator.language || "en";
        document.getElementById('icon-lang').className = "fas fa-info-circle text-blue-400";
        document.getElementById('desc-lang').innerText = `Browser: ${browserLang}, IP: ${countryCode}`;

        // 7. TOR Check
        const torKeywords = ['tor exit', 'tor project', 'onion', 'ielo liazo', '100up', 'online.net', 'stiftung erneuerbare freiheit', 'linode', 'dotsrc', 'quxlabs', 'flokinet', '1337 services'];
        let isTorMatch = false;

        if (matchedBrand) {
            const matchedLower = matchedBrand.toLowerCase();
            isTorMatch = torKeywords.some(k => matchedLower.includes(k));
        }

        if (isTorMatch) {
            document.getElementById('icon-tor').className = "fas fa-exclamation-circle text-orange-500";

            if (matchedBrand.includes("Tor Exit Node")) {
                document.getElementById('desc-tor').innerText = "Confirmed Tor Exit Node";
                document.getElementById('icon-tor').className = "fas fa-exclamation-triangle text-red-500";
            } else {
                document.getElementById('desc-tor').innerText = "Maybe (Infra Match)";
            }
        } else if (/tor exit|tor project|onion/i.test(combinedName)) {
            document.getElementById('icon-tor').className = "fas fa-exclamation-triangle text-red-500";
            document.getElementById('desc-tor').innerText = "Tor Node Confirmed";
        } else {
            document.getElementById('icon-tor').className = "fas fa-check-circle text-emerald-500";
            document.getElementById('desc-tor').innerText = "No Tor fingerprints found";
        }


        // --- SCORING & DISPLAY ---
        if (score >= 50) {
            // DETECTED (Red)
            const finalName = matchedBrand || "Detected (Unknown)";
            let cardStatus = "VPN Detected";

            // 1. Refine Status based on confidence modifiers
            if (finalName.includes("Possible")) {
                cardStatus = "VPN Detected";
            } else if (finalName.includes("Likely")) {
                cardStatus = "VPN Detected";
            }

            // 2. Refine specifically for Tor/Anonymity infra (MODIFIED STATUS & FRAUD RISK)
            if (isTorMatch) {
                if (finalName.includes("Possible") || finalName.includes("Likely")) {
                    cardStatus = "Tor Network May Detected";
                } else if (finalName.includes("Tor Exit Node")) {
                    cardStatus = "Tor Confirmed";
                } else {
                    cardStatus = "Tor Network May Detected";
                }

                // *** USER REQUESTED CHANGE: Downgrade Fraud Risk for Tor ***
                fraudEl.innerText = "Medium Risk (Tor)";
                fraudEl.className = "font-bold text-orange-500";

                badgeEl.innerText = "High Anonymity (Tor)";
                badgeEl.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-orange-100 text-orange-700";

            } else {
                // Generic VPN (Nord, PIA, etc.) - Remains High Risk
                badgeEl.innerText = "High Anonymity";
                badgeEl.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-red-100 text-red-700";
                fraudEl.innerText = "High Risk (Flagged)";
                fraudEl.className = "font-bold text-red-500";
            }

            vpnEl.innerText = cardStatus;
            vpnEl.className = "text-lg font-bold mt-1 text-red-600";
            detailEl.innerHTML = "";

            providerNameEl.innerText = finalName.replace("Detected (Likely ", "").replace(")", "");
            providerNameEl.className = "font-bold text-red-600";

        } else if (score > 0) {
            // LIKELY (Orange)
            vpnEl.innerText = "Likely Detected";
            vpnEl.className = "text-lg font-bold mt-1 text-orange-500";
            detailEl.innerHTML = "";

            providerNameEl.innerText = "Generic / Datacenter";
            providerNameEl.className = "font-bold text-orange-500";

            badgeEl.innerText = "Moderate Anonymity";
            badgeEl.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-orange-100 text-orange-700";
            fraudEl.innerText = "Medium Risk";
            fraudEl.className = "font-bold text-orange-500";

        } else {
            // CLEAN (Green/Black)
            vpnEl.innerText = "Not Detected";
            vpnEl.className = "text-lg font-bold mt-1 text-slate-800";
            detailEl.innerHTML = `Direct Connection`;

            providerNameEl.innerText = "Residential / None";
            providerNameEl.className = "font-bold text-emerald-600";

            badgeEl.innerText = "Low Anonymity";
            badgeEl.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-emerald-100 text-emerald-700";
            fraudEl.innerText = "Low Risk (Clean)";
            fraudEl.className = "font-bold text-emerald-500";
        }
    }
    // --- 4. DATA FETCHERS ---
    function updateTimestamp() {
        const n = new Date();
        const f = (x) => String(x).padStart(2,'0');

        // Offset
        const offset = -n.getTimezoneOffset();
        const sign = offset >= 0 ? '+' : '-';
        const pad = val => String(Math.floor(Math.abs(val))).padStart(2, '0');
        const utcStr = `UTC${sign}${pad(offset/60)}:${pad(offset%60)}`;

        document.getElementById('last-update').innerText = `${f(n.getDate())}/${f(n.getMonth()+1)}/${n.getFullYear()} , ${f(n.getHours())}:${f(n.getMinutes())}:${f(n.getSeconds())} ${utcStr}`;
    }
    setInterval(updateTimestamp,1000); updateTimestamp();

    let map;
    function initMap(lat,lng) { if(map)return; map=L.map('map',{zoomControl:false}).setView([lat,lng],13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:' OpenStreetMap'}).addTo(map); L.marker([lat,lng]).addTo(map).bindPopup("<b>IP Location</b>").openPopup(); document.getElementById('map-coords').innerText=`${lat.toFixed(4)}, ${lng.toFixed(4)}`; }

    async function fetchIPv4Data() { try{const r=await fetch('https://ipwho.is/');const d=await r.json();if(d.success){
        document.getElementById('ipv4-display').innerText=d.ip;
        document.getElementById('ipv4-loc').innerText=`${d.city}, ${d.region_code}`;

        // UPDATED: Populate 4 new fields
        document.getElementById('isp-display').innerText = d.connection.isp || "Unknown";
        document.getElementById('org-display').innerText = d.connection.org || "Unknown";
        document.getElementById('as-org-display').innerText = d.connection.org || "Unknown"; // Usually mapped to org in this API
        document.getElementById('asn-display').innerText = d.connection.asn || "--";

        document.getElementById('hostname-display').innerText=d.connection.domain||"No PTR Record";
        initMap(d.latitude,d.longitude);
        // UPDATED: Pass 'utc' field to detectVPN for offset comparison
        // Also passing org and asn now
        detectVPN(d.timezone.id, d.timezone.utc, d.connection.isp, d.country_code, d.connection.org, d.connection.asn);
    }}catch(e){document.getElementById('ipv4-display').innerText="Error";}}

    // --- UPDATED: IPv6 Detection with Fallback Provider ---
    async function fetchIPv6Data() {
        try {
            // 1. Force IPv6 Connection to get the Address
            const r = await fetch('https://api6.ipify.org?format=json');

            if(r.ok) {
                const d = await r.json();
                document.getElementById('ipv6-display').innerText = d.ip;
                document.getElementById('ipv6-status').innerText = "Active";
                document.getElementById('ipv6-status').className = "text-xs text-emerald-500 font-bold mt-1";

                // 2. Get Metadata (ISP Name)
                // Strategy: Try ipapi.co first, fall back to ipwho.is
                try {
                    const dr = await fetch(`https://ipapi.co/${d.ip}/json/`);
                    if (!dr.ok) throw new Error("ipapi failed");

                    const dd = await dr.json();
                    const provider = dd.org || dd.asn || "Unknown";
                    document.getElementById('ipv6-provider').innerText = provider;

                } catch (primaryErr) {
                    console.log("Primary IPv6 API failed, trying backup...");

                    // Backup: ipwho.is
                    try {
                        const dr2 = await fetch(`https://ipwho.is/${d.ip}`);
                        const dd2 = await dr2.json();
                        if(dd2.success) {
                            document.getElementById('ipv6-provider').innerText = dd2.connection.isp || dd2.connection.org || "Unknown";
                        } else {
                            document.getElementById('ipv6-provider').innerText = "Unknown (API Limit)";
                        }
                    } catch(backupErr) {
                        document.getElementById('ipv6-provider').innerText = "Unknown";
                    }
                }
            }
        } catch(e) {
            // General Failure (User likely has no IPv6)
            document.getElementById('ipv6-display').innerText = "Not Detected";
            document.getElementById('ipv6-status').innerText = "IPv4 Only";
            document.getElementById('ipv6-provider').innerText = "--";
        }
    }

    // --- 5. UPDATED: DNS Detection (No "N/A" Fallback) ---
    async function fetchDNS() {
        const list = document.getElementById('dns-list');
        const badge = document.getElementById('dns-count-badge');

        // UI Reset
        list.innerHTML = `
            <li class="text-sm text-gray-600 flex items-center h-full">
                <span class="loader mr-2"></span>
                <span class="flex flex-col">
                    <span>Probing DNS Resolvers...</span>
                    <span class="text-[10px] text-gray-400">Fetching raw provider data</span>
                </span>
            </li>`;

        const detected = new Map();
        const BATCH_SIZE = 10;

// Inside your fetchDNS function, update the runBatch function:

        const runBatch = async () => {
            const promises = Array(BATCH_SIZE).fill(0).map(async () => {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);

                    const res = await fetch(`https://edns.ip-api.com/json?r=${Math.random()}`, {
                        signal: controller.signal,
                        cache: 'no-store'
                    });
                    clearTimeout(timeoutId);

                    // CRITICAL: Check for non-200 status codes returned by the API server
                    if (!res.ok) {
                        // If the API returns 429 (Rate Limit) or 500, we still return null
                        console.warn(`DNS Probe API returned status code: ${res.status}`);
                        return null;
                    }

                    const data = await res.json();
                    return (data.dns && data.dns.ip) ? data.dns : null;

                } catch(e) {
                    // This catches network errors, ad-blocker blocks, and timeouts.
                    // We simply log and return null so the other 19 attempts continue.
                    console.error("DNS Probe attempt failed:", e.message);
                    return null;
                }
            });
            return Promise.all(promises);
        };

        // Execution
        let results = await runBatch();
        await new Promise(r => setTimeout(r, 250));
        const results2 = await runBatch();
        results = results.concat(results2);

        // Process Data
        let totalSuccessful = 0;
        results.forEach(dns => {
            if(dns) {
                totalSuccessful++;
                if(detected.has(dns.ip)) {
                    detected.get(dns.ip).count++;
                } else {
                    detected.set(dns.ip, { data: dns, count: 1 });
                }
            }
        });

        // Render
        list.innerHTML = '';
        const uniqueCount = detected.size;

        if(uniqueCount > 0) {
            badge.innerText = `${uniqueCount} SERVER${uniqueCount > 1 ? 'S' : ''}`;
            badge.classList.remove('hidden');

            const sorted = Array.from(detected.values()).sort((a, b) => b.count - a.count);

            sorted.forEach(item => {
                const dns = item.data;
                const percentage = Math.round((item.count / totalSuccessful) * 100);

                // --- PROVIDER NAMING LOGIC ---
                // 1. Get the raw ISP string. Default to empty string if null.
                let providerName = dns.isp || "";

                // 2. Optional: Beautify ONLY major Public DNS for readability.
                // Otherwise, the raw 'providerName' is preserved.
                const lowerIsp = providerName.toLowerCase();

                if (lowerIsp.includes("google")) providerName = "Google DNS";
                else if (lowerIsp.includes("cloudflare")) providerName = "Cloudflare";
                else if (lowerIsp.includes("opendns")) providerName = "OpenDNS";
                else if (lowerIsp.includes("quad9")) providerName = "Quad9";
                else if (lowerIsp.includes("cisco")) providerName = "Cisco Umbrella";

                // 3. NO "N/A" FALLBACK
                // We show exactly what 'providerName' is, even if it is the raw string.

                const geoInfo = dns.geo || "";

                list.innerHTML += `
                    <li class="mb-3 pb-2 border-b border-gray-100 last:border-0 last:pb-0 last:mb-0">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-sm font-bold text-slate-700 font-mono">${dns.ip}</span>
                            <span class="text-[10px] font-bold bg-gray-100 text-gray-500 px-1.5 rounded">${percentage}% Traffic</span>
                        </div>
                        <div class="flex justify-between items-start">
                             <div class="flex flex-col leading-tight">
                                <span class="text-xs font-bold text-blue-600 break-all">${providerName}</span>
                                <span class="text-[10px] text-gray-400 mt-0.5">${geoInfo}</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-100 h-1 mt-1.5 rounded-full overflow-hidden">
                            <div class="bg-blue-500 h-full transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                    </li>
                `;
            });
        } else {
            list.innerHTML = `
                <li class="p-3 bg-red-50 rounded border border-red-100 text-center">
                    <p class="text-xs font-bold text-red-600">Detection Failed</p>
                    <p class="text-[10px] text-red-400 mt-1">Check adblocker or network settings</p>
                </li>`;
        }
    }

    // UPDATED: WebRTC Leak Check (Smart Logic)
    // UPDATED: WebRTC Leak Check with "VPN Off" Logic
    // --- 6. UPDATED: WebRTC Leak Check (Fix for VPN False Positives) ---
    function getWebRTCIPs() {
        const l = document.getElementById('webrtc-list');
        const icon = document.getElementById('icon-webrtc');
        const desc = document.getElementById('desc-webrtc');

        const foundIPs = new Set();
        let isScanning = true;

        const R = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
        if (!R) {
            l.innerHTML = '<li>Unsupported</li>';
            return;
        }

        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        const p = new R(config);

        // Create a data channel to force ICE candidate gathering
        try { p.createDataChannel(''); } catch(e) {}

        p.onicecandidate = (e) => {
            if (!e.candidate) return;
            const candidate = e.candidate.candidate;
            // Extract IP using Regex
            const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/);

            if (ipMatch) {
                const ip = ipMatch[1];
                if (candidate.indexOf(".local") > -1) return; // Ignore mDNS

                if (!foundIPs.has(ip)) {
                    foundIPs.add(ip);
                    if (isScanning) {
                        l.innerHTML = '';
                        isScanning = false;
                    }

                    // Helper to check if IP is private
                    // UPDATED: Now includes 100.64.0.0/10 (CGNAT/VPN) and 169.254 (Link Local)
                    const isPrivate = /^(192\.168\.|10\.|172\.(1[6-9]|2\d|3[01])\.|127\.|169\.254\.|100\.(6[4-9]|[7-9][0-9]|1[0-1][0-9]|12[0-7])\.|fd|fc|fe80)/i.test(ip);

                    const cssClass = isPrivate ? "text-gray-400" : "text-slate-800 font-bold";
                    const note = isPrivate ? " (Local/VPN)" : "";

                    l.innerHTML += `<li class="${cssClass} font-mono text-sm mb-1">${ip}${note}</li>`;
                }
            }
        };

        p.createOffer().then(d => p.setLocalDescription(d)).catch(e => {});

        // Continuous Analysis
        const analyzer = setInterval(() => {
            const ipv4 = document.getElementById('ipv4-display').innerText.trim();
            const ipv6 = document.getElementById('ipv6-display').innerText.trim();
            const vpnStatusText = document.getElementById('vpn-status').innerText;
            const isVpnOff = vpnStatusText.includes("Not Detected");

            if (ipv4 === '--' || ipv4.includes('Loader') || ipv4 === 'Error') {
                desc.innerText = "Waiting for Main IP...";
                return;
            }

            let status = "safe";

            if (foundIPs.size === 0) return;

            foundIPs.forEach(ip => {
                // Same Private IP Regex for logic check
                const isPrivate = /^(192\.168\.|10\.|172\.(1[6-9]|2\d|3[01])\.|127\.|169\.254\.|100\.(6[4-9]|[7-9][0-9]|1[0-1][0-9]|12[0-7])\.|fd|fc|fe80)/i.test(ip);

                if (!isPrivate) {
                    // Normalize IPs for comparison (lowercase)
                    const normIp = ip.toLowerCase();
                    const normV4 = ipv4.toLowerCase();
                    const normV6 = ipv6.toLowerCase();

                    // Check strict match against Dashboard IPs
                    const matchesTunnel = (normIp === normV4) || (normIp === normV6);

                    if (!matchesTunnel) {
                        status = "leak"; // Priority 1: Critical Leak
                    } else if (status !== "leak" && isVpnOff) {
                        status = "exposed"; // Priority 2: Matches but VPN is off
                    }
                }
            });

            // UI Update
            if (status === "leak") {
                icon.className = "fas fa-exclamation-triangle text-red-600 blink";
                desc.innerText = "CRITICAL: Real IP Leaked!";
                desc.className = "text-[10px] text-red-600 font-bold";
                clearInterval(analyzer);
            }
            else if (status === "exposed") {
                icon.className = "fas fa-exclamation-triangle text-orange-500";
                desc.innerText = "VPN Off  WebRTC Exposed";
                desc.className = "text-[10px] text-orange-600 font-bold";
            }
            else {
                icon.className = "fas fa-check-circle text-emerald-500";
                desc.innerText = "Safe (Matches Tunnel IP)";
                desc.className = "text-[10px] text-emerald-600 font-bold";
            }

        }, 1000);

        // Timeout fallback
        setTimeout(() => {
            if (foundIPs.size === 0) {
                l.innerHTML = '<li class="text-xs text-gray-400">Hidden by Browser Privacy</li>';
                icon.className = "fas fa-shield-alt text-emerald-500";
                desc.innerText = "WebRTC Disabled/Hidden";
                desc.className = "text-[10px] text-gray-500";
                clearInterval(analyzer);
            }
        }, 5000);
    }


    async function detectSystem() {
        const u=navigator.userAgent;
        // UPDATED: Populate Modal ID instead of removed card
        document.getElementById('modal-ua-raw').innerText=u;

        // --- NEW: Calculate UTC Offset for Display ---
        const d = new Date();
        const offset = -d.getTimezoneOffset(); // returns minutes (inverted)
        const sign = offset >= 0 ? '+' : '-';
        const pad = n => String(Math.floor(Math.abs(n))).padStart(2, '0');
        const utcStr = `UTC${sign}${pad(offset/60)}:${pad(offset%60)}`;

        document.getElementById('sys-tz').innerHTML = `Sys Timezone: <span class="font-bold text-slate-600">${utcStr}</span> <i class="fas fa-info-circle text-[10px] ml-1"></i>`;

        let o="Unknown",b="Unknown"; if(navigator.userAgentData){const v=await navigator.userAgentData.getHighEntropyValues(["platformVersion"]);const m=parseInt(v.platformVersion?.split('.')[0]||0);o=(m>=13)?"Windows 11":"Windows 10";}else{if(u.includes("Win"))o="Windows";if(u.includes("Mac"))o="macOS";if(u.includes("Linux"))o="Linux";if(u.includes("Android"))o="Android";if(u.includes("like Mac"))o="iOS";} if(u.includes("Firefox"))b="Firefox";else if(u.includes("Chrome"))b="Chrome";else if(u.includes("Safari"))b="Safari";else if(u.includes("Edg"))b="Edge"; document.getElementById('os-name').innerText=o; document.getElementById('os-detail').innerText=(u.includes("64")?"64-bit":"32-bit"); document.getElementById('browser-name').innerText=b; const v=u.match(/(?:Chrome|Firefox|Version|Edg)\/([0-9.]+)/); document.getElementById('browser-ver').innerText=v?"v"+v[1]:"";

        // --- BROWSER DETAILS POPULATION (NEW) ---
        // Basic detection
        let browserName = "Unknown", browserVer = "--", engineName = "--", engineVer = "--";
        if(u.indexOf("Firefox") > -1) {
            browserName = "Firefox";
            browserVer = u.match(/Firefox\/([0-9.]+)/)?.[1] || "";
            engineName = "Gecko";
            engineVer = u.match(/Gecko\/([0-9]+)/)?.[1] || "";
        } else if(u.indexOf("Chrome") > -1) {
            browserName = "Chrome";
            if(u.indexOf("Edg") > -1) browserName = "Edge";
            browserVer = u.match(/(?:Chrome|Edg)\/([0-9.]+)/)?.[1] || "";
            engineName = "Blink";
            engineVer = u.match(/AppleWebKit\/([0-9.]+)/)?.[1] || "";
        } else if(u.indexOf("Safari") > -1) {
            browserName = "Safari";
            browserVer = u.match(/Version\/([0-9.]+)/)?.[1] || "";
            engineName = "WebKit";
            engineVer = u.match(/AppleWebKit\/([0-9.]+)/)?.[1] || "";
        }

        document.getElementById('br-name').innerText = browserName;
        document.getElementById('br-ver').innerText = browserVer;
        document.getElementById('br-eng').innerText = engineName;
        document.getElementById('br-eng-ver').innerText = engineVer;

        // Privacy
        document.getElementById('priv-dnt').innerText = navigator.doNotTrack === "1" ? "Enabled" : "Disabled";
        // UPDATED: Cookies Moved to Browser Modal
        document.getElementById('br-cookies').innerText = navigator.cookieEnabled ? "Enabled" : "Disabled";
        // UPDATED: JS Check Added to Browser Modal
        document.getElementById('br-js').innerText = "Enabled";

        // --- OS HARDWARE DETAILS POPULATION (NEW) ---
        document.getElementById('os-cores').innerText = navigator.hardwareConcurrency || "Unknown";

        // Arch / Bitness
        let arch = "x86";
        if(u.includes("Win64") || u.includes("x64")) arch = "x86-64";
        else if(u.includes("arm")) arch = "ARM";

        document.getElementById('os-arch').innerText = arch;
        document.getElementById('os-bitness').innerText = u.includes("64") ? "64-bit" : "32-bit";
        document.getElementById('os-memory').innerText = (navigator.deviceMemory ? `>=${navigator.deviceMemory}` : "Unknown") + " GB";

        // Screen
        const s = window.screen;
        document.getElementById('os-res').innerText = `${s.width} x ${s.height}`;
        document.getElementById('os-cdepth').innerText = `${s.colorDepth}-bit`;
        document.getElementById('os-pdepth').innerText = `${s.pixelDepth}-bit`;

        // Orientation
        let orient = "Landscape";
        if(s.orientation && s.orientation.type) orient = s.orientation.type.replace("-", " ");
        else if(window.innerHeight > window.innerWidth) orient = "Portrait";
        document.getElementById('os-orient').innerText = orient;

        // Capabilities
        const aud = new Audio();
        let codecs = [];
        if(aud.canPlayType('audio/mpeg')) codecs.push("MP3");
        if(aud.canPlayType('audio/mp4')) codecs.push("AAC");
        document.getElementById('os-media').innerText = codecs.join(", ") || "Basic";
        document.getElementById('os-pdf').innerText = navigator.pdfViewerEnabled ? "Supported" : "No";
        document.getElementById('os-vendor').innerText = navigator.vendor || "Unknown";
        document.getElementById('os-model').innerText = "Desktop/Generic"; // Simplified
    }

    // UPDATED COPY FUNCTION
    function copyUA() {
        navigator.clipboard.writeText(document.getElementById('modal-ua-raw').innerText);
        alert("Copied!");
    }

    fetchIPv4Data(); fetchIPv6Data(); fetchDNS(); getWebRTCIPs(); detectSystem();
</script>
</body>
</html>